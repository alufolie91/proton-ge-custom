From 528316b059a8912fdf616d8a872946cd7031530a Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty <etaash.mathamsetty@gmail.com>
Date: Tue, 5 Aug 2025 12:57:56 -0400
Subject: [PATCH 218/336] winewayland: Use true display width and height.

---
 dlls/winewayland.drv/display.c        | 16 +++++++++++-----
 dlls/winewayland.drv/wayland_output.c | 10 +++++++---
 dlls/winewayland.drv/waylanddrv.h     |  1 +
 3 files changed, 19 insertions(+), 8 deletions(-)

diff --git a/dlls/winewayland.drv/display.c b/dlls/winewayland.drv/display.c
index 2b652b9131c..aa5954c4c00 100644
--- a/dlls/winewayland.drv/display.c
+++ b/dlls/winewayland.drv/display.c
@@ -277,9 +277,15 @@ static UINT get_edid(const struct output_info *output_info, unsigned char **data
     struct wayland_output_mode *mode = output_info->output->current_mode;
     const struct wayland_primaries *primaries = &output_info->output->primaries;
 
-    /* assume ~150 dpi */
-    mwidth = mode->width / 60;
-    mheight = mode->height / 60;
+    mwidth = output_info->output->width_mm;
+    mheight = output_info->output->height_mm;
+
+    if (mwidth == 0 || mheight == 0)
+    {
+        /* assume ~150 dpi */
+        mwidth = mode->width / 60;
+        mheight = mode->height / 60;
+    }
 
     /* another 128 bytes needed for CTA-861 extension */
     *data_out = calloc( 1, edid_size );
@@ -291,8 +297,8 @@ static UINT get_edid(const struct output_info *output_info, unsigned char **data
     data[18] = 1;
     data[19] = 4;
     data[20] = 0xa0; /* FIXME */
-    data[21] = mwidth;
-    data[22] = mheight;
+    data[21] = round(mwidth / 10.0); /* cm */
+    data[22] = round(mheight / 10.0); /* cm */
     data[24] = 0x6;
     data[25] = ((primaries->r_x & 0x3) << 6) | ((primaries->r_y & 0x3) << 4) |
                ((primaries->g_x & 0x3) << 2) | (primaries->g_y & 0x3);
diff --git a/dlls/winewayland.drv/wayland_output.c b/dlls/winewayland.drv/wayland_output.c
index 7b444b8c628..cec4598ca07 100644
--- a/dlls/winewayland.drv/wayland_output.c
+++ b/dlls/winewayland.drv/wayland_output.c
@@ -39,7 +39,7 @@ static uint32_t next_output_id = 0;
 #define WAYLAND_OUTPUT_CHANGED_NAME       0x02
 #define WAYLAND_OUTPUT_CHANGED_LOGICAL_XY 0x04
 #define WAYLAND_OUTPUT_CHANGED_LOGICAL_WH 0x08
-#define WAYLAND_OUTPUT_CHANGED_TRANSFORM  0x10
+#define WAYLAND_OUTPUT_CHANGED_GEOMETRY  0x10
 #define WAYLAND_OUTPUT_CHANGED_PRIMARIES  0x20
 #define WAYLAND_OUTPUT_CHANGED_FALL       0x40
 #define WAYLAND_OUTPUT_CHANGED_CLL        0x80
@@ -178,9 +178,11 @@ static void wayland_output_done(struct wayland_output *output)
         output->current.logical_h = output->pending.logical_h;
     }
 
-    if (output->pending_flags & WAYLAND_OUTPUT_CHANGED_TRANSFORM)
+    if (output->pending_flags & WAYLAND_OUTPUT_CHANGED_GEOMETRY)
     {
         output->current.transform = output->pending.transform;
+        output->current.width_mm = output->pending.width_mm;
+        output->current.height_mm = output->pending.height_mm;
     }
 
 
@@ -236,8 +238,10 @@ static void output_handle_geometry(void *data, struct wl_output *wl_output,
     struct wayland_output *output = data;
 
     output->pending.transform = output_transform;
+    output->pending.width_mm = physical_width;
+    output->pending.height_mm = physical_height;
 
-    output->pending_flags |= WAYLAND_OUTPUT_CHANGED_TRANSFORM;
+    output->pending_flags |= WAYLAND_OUTPUT_CHANGED_GEOMETRY;
 }
 
 static void output_handle_mode(void *data, struct wl_output *wl_output,
diff --git a/dlls/winewayland.drv/waylanddrv.h b/dlls/winewayland.drv/waylanddrv.h
index 0892ea24af8..2641123b156 100644
--- a/dlls/winewayland.drv/waylanddrv.h
+++ b/dlls/winewayland.drv/waylanddrv.h
@@ -252,6 +252,7 @@ struct wayland_output_state
     int logical_x, logical_y;
     int logical_w, logical_h;
     int transform;
+    int width_mm, height_mm;
 };
 
 struct wayland_output
-- 
2.51.0

