From 5a0888d94e0137bc377aa96137ac795ccbacd544 Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Sat, 13 Dec 2025 11:46:28 -0600
Subject: [PATCH 413/414] winewayland/vulkan: minor refactors to match upstream
 wine.

---
 dlls/winewayland.drv/vulkan.c | 35 +++++++++++++++++++----------------
 1 file changed, 19 insertions(+), 16 deletions(-)

diff --git a/dlls/winewayland.drv/vulkan.c b/dlls/winewayland.drv/vulkan.c
index a53cdc9d786..ee10dd21398 100644
--- a/dlls/winewayland.drv/vulkan.c
+++ b/dlls/winewayland.drv/vulkan.c
@@ -35,7 +35,7 @@
 #include "wine/vulkan.h"
 #include "wine/vulkan_driver.h"
 
-WINE_DEFAULT_DEBUG_CHANNEL(vulkan);
+WINE_DEFAULT_DEBUG_CHANNEL(waylanddrv);
 
 #ifdef SONAME_LIBVULKAN
 
@@ -55,17 +55,6 @@ static VkBool32 (*pvkGetPhysicalDeviceWaylandPresentationSupportKHR)(VkPhysicalD
 
 static const struct vulkan_driver_funcs wayland_vulkan_driver_funcs;
 
-static void wine_vk_surface_destroy(struct wayland_client_surface *client)
-{
-    HWND hwnd = wl_surface_get_user_data(client->wl_surface);
-    struct wayland_win_data *data = wayland_win_data_get(hwnd);
-
-    if (wayland_client_surface_release(client) && data)
-        data->client_surface = NULL;
-
-    if (data) wayland_win_data_release(data);
-}
-
 static BOOL vulkan_opwr_disabled(void)
 {
     static int disabled = -1;
@@ -119,7 +108,7 @@ static VkResult wayland_vulkan_surface_create(HWND hwnd, const struct vulkan_ins
     if (res != VK_SUCCESS)
     {
         ERR("Failed to create vulkan wayland surface, res=%d\n", res);
-        wine_vk_surface_destroy(client);
+        wayland_client_surface_release(client);
         return res;
     }
 
@@ -130,17 +119,31 @@ static VkResult wayland_vulkan_surface_create(HWND hwnd, const struct vulkan_ins
     return VK_SUCCESS;
 }
 
-static void wayland_vulkan_surface_destroy(HWND hwnd, void *private)
+static void wayland_vulkan_surface_detach(HWND hwnd, void *private)
 {
     struct wayland_client_surface *client = private;
+    struct wayland_win_data *data;
 
     TRACE("%p %p\n", hwnd, private);
 
-    wine_vk_surface_destroy(client);
+    if (!(data = wayland_win_data_get(hwnd))) return;
+
+    if (data->client_surface == client)
+        data->client_surface = NULL;
+
+    wayland_client_surface_detach(client);
+
+    wayland_win_data_release(data);
 }
 
-static void wayland_vulkan_surface_detach(HWND hwnd, void *private)
+static void wayland_vulkan_surface_destroy(HWND hwnd, void *private)
 {
+    struct wayland_client_surface *client = private;
+
+    TRACE("%p %p\n", hwnd, private);
+
+    wayland_vulkan_surface_detach(hwnd, client);
+    wayland_client_surface_release(client);
 }
 
 static void wayland_vulkan_surface_update(HWND hwnd, void *private)
-- 
2.51.1

