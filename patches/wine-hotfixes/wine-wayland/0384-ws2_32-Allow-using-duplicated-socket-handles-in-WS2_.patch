From 2aaed939957fef9b3bc4b0bfc02856427ed8317b Mon Sep 17 00:00:00 2001
From: Elizabeth Figura <zfigura@codeweavers.com>
Date: Fri, 18 Apr 2025 14:24:27 -0500
Subject: [PATCH 384/441] ws2_32: Allow using duplicated socket handles in
 WS2_sendto().

Wine-Bug: http://bugs.winehq.org/show_bug.cgi?id=58122
---
 dlls/ws2_32/socket.c     | 21 ++++++++++++++++++++-
 dlls/ws2_32/tests/sock.c |  8 ++++----
 2 files changed, 24 insertions(+), 5 deletions(-)

diff --git a/dlls/ws2_32/socket.c b/dlls/ws2_32/socket.c
index eb84558cbac..988a94b6af7 100644
--- a/dlls/ws2_32/socket.c
+++ b/dlls/ws2_32/socket.c
@@ -436,6 +436,25 @@ static BOOL socket_list_remove( SOCKET socket )
     return FALSE;
 }
 
+
+static BOOL is_valid_socket( SOCKET socket )
+{
+    NTSTATUS status = STATUS_SUCCESS;
+    IO_STATUS_BLOCK io;
+
+    if (socket_list_find( socket ))
+        return TRUE;
+
+    /* Some functions allow socket handles output with DuplicateHandle(), which
+     * will not be in the socket list. We can't necessarily just delegate to
+     * ntdll to check the handle type, because sometimes we need to check the
+     * handle validity *before* checking e.g. pointer validity.
+     * Instead try to perform an ioctl to see if it's truly a socket. */
+    return NtDeviceIoControlFile( (HANDLE)socket, NULL, NULL, NULL, &io, IOCTL_AFD_WINE_COMPLETE_ASYNC,
+                                  &status, sizeof(status), NULL, 0 ) == STATUS_SUCCESS;
+}
+
+
 static INT WINAPI WSA_DefaultBlockingHook( FARPROC x );
 
 int num_startup;
@@ -1000,7 +1019,7 @@ static int WS2_sendto( SOCKET s, WSABUF *buffers, DWORD buffer_count, DWORD *ret
            "addr_len %d, overlapped %p, completion %p\n",
            s, buffers, buffer_count, flags, addr, addr_len, overlapped, completion );
 
-    if (!socket_list_find( s ))
+    if (!is_valid_socket( s ))
     {
         SetLastError( WSAENOTSOCK );
         return -1;
diff --git a/dlls/ws2_32/tests/sock.c b/dlls/ws2_32/tests/sock.c
index df8adcd0343..82eff3e2b32 100644
--- a/dlls/ws2_32/tests/sock.c
+++ b/dlls/ws2_32/tests/sock.c
@@ -14478,20 +14478,20 @@ static void test_valid_handle(void)
     invalid = CreateEventA(NULL, TRUE, TRUE, NULL);
 
     ret = send((SOCKET)duplicated, buffer, 1, 0);
-    todo_wine ok(ret == 1, "got %d\n", ret);
+    ok(ret == 1, "got %d\n", ret);
 
     ret = sendto((SOCKET)duplicated, buffer, 1, 0, NULL, 0);
-    todo_wine ok(ret == 1, "got %d\n", ret);
+    ok(ret == 1, "got %d\n", ret);
 
     wsabuf.buf = buffer;
     wsabuf.len = 1;
 
     ret = WSASend((SOCKET)duplicated, &wsabuf, 1, NULL, 0, NULL, NULL);
     ok(ret == -1, "got %d\n", ret);
-    todo_wine ok(WSAGetLastError() == WSAEFAULT, "got error %u\n", WSAGetLastError());
+    ok(WSAGetLastError() == WSAEFAULT, "got error %u\n", WSAGetLastError());
 
     ret = WSASend((SOCKET)duplicated, &wsabuf, 1, &size, 0, NULL, NULL);
-    todo_wine ok(!ret, "got %d\n", ret);
+    ok(!ret, "got %d\n", ret);
 
     ret = WSASend((SOCKET)invalid, &wsabuf, 1, NULL, 0, NULL, NULL);
     ok(ret == -1, "got %d\n", ret);
-- 
2.51.0

