From 0fe4157549d23c0974b71e4b46a2fe3a873089f6 Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Tue, 9 Dec 2025 13:07:38 -0600
Subject: [PATCH 410/473] winewayland: Don't send pointer updates when there is
 a pending warp.

---
 dlls/winewayland.drv/wayland_pointer.c | 14 +++++++++++++-
 1 file changed, 13 insertions(+), 1 deletion(-)

diff --git a/dlls/winewayland.drv/wayland_pointer.c b/dlls/winewayland.drv/wayland_pointer.c
index 5290990eaa1..4b3908e9c20 100644
--- a/dlls/winewayland.drv/wayland_pointer.c
+++ b/dlls/winewayland.drv/wayland_pointer.c
@@ -367,6 +367,17 @@ static void pointer_handle_frame(void *data, struct wl_pointer *wl_pointer)
 
     input.type = INPUT_MOUSE;
 
+    /*
+     * if there is a pending set cursor position triggered by another thread,
+     * then we cannot send any motion events
+     */
+    if (pointer->pending_warp)
+    {
+        pointer->pointer_frame.flags &= ~(WAYLAND_POINTER_FRAME_ABS
+                                        | WAYLAND_POINTER_FRAME_REL);
+        TRACE("Pointer warp is pending, ignoring motion!\n");
+    }
+
     if (pointer->pointer_frame.flags & WAYLAND_POINTER_FRAME_ABS)
     {
         input.mi.dx = pointer->pointer_frame.x;
@@ -1296,7 +1307,8 @@ BOOL WAYLAND_ClipCursor(const RECT *clip, BOOL reset)
                                         wl_fixed_from_int(warp_x),
                                         wl_fixed_from_int(warp_y),
                                         pointer->enter_serial);
-        TRACE("Warping hwnd=%p warp_xy=%d,%d\n", hwnd, warp_x, warp_y);
+        TRACE("Warping hwnd=%p warp_xy=%d,%d screen_xy=%d,%d\n",
+              hwnd, warp_x, warp_y, (int)cursor_pos.x, (int)cursor_pos.y);
         pointer->pending_warp = FALSE;
     }
     else if (wl_surface && pointer->pending_warp)
-- 
2.52.0

