From 4e3d125fa04fc59948e84bc3d3be698b71f21934 Mon Sep 17 00:00:00 2001
From: Brendan Shanks <bshanks@codeweavers.com>
Date: Fri, 7 Nov 2025 15:45:28 -0800
Subject: [PATCH 427/473] win32u: Add semi-stub for
 NtUserDisplayConfigGetDeviceInfo(
 DISPLAYCONFIG_DEVICE_INFO_GET_ADVANCED_COLOR_INFO ).

---
 dlls/user32/tests/monitor.c |  2 +-
 dlls/win32u/sysparams.c     | 49 +++++++++++++++++++++++++------------
 2 files changed, 34 insertions(+), 17 deletions(-)

diff --git a/dlls/user32/tests/monitor.c b/dlls/user32/tests/monitor.c
index e6e09f33a06..e03e6a38bae 100644
--- a/dlls/user32/tests/monitor.c
+++ b/dlls/user32/tests/monitor.c
@@ -2039,7 +2039,7 @@ static void test_QueryDisplayConfig_result(UINT32 flags,
         color_info.header.adapterId = pi[i].targetInfo.adapterId;
         color_info.header.id = pi[i].targetInfo.id;
         ret = pDisplayConfigGetDeviceInfo(&color_info.header);
-        todo_wine ok(!ret || broken(ret == ERROR_INVALID_PARAMETER) /* before Win10 1709 */,
+        ok(!ret || broken(ret == ERROR_INVALID_PARAMETER) /* before Win10 1709 */,
                 "Expected 0, got %ld\n", ret);
 
         /* Check corresponding modes */
diff --git a/dlls/win32u/sysparams.c b/dlls/win32u/sysparams.c
index c3787943d5a..52133c8df54 100644
--- a/dlls/win32u/sysparams.c
+++ b/dlls/win32u/sysparams.c
@@ -7620,31 +7620,48 @@ NTSTATUS WINAPI NtUserDisplayConfigGetDeviceInfo( DISPLAYCONFIG_DEVICE_INFO_HEAD
     }
     case DISPLAYCONFIG_DEVICE_INFO_GET_ADVANCED_COLOR_INFO:
     {
-        DISPLAYCONFIG_GET_ADVANCED_COLOR_INFO *info = (DISPLAYCONFIG_GET_ADVANCED_COLOR_INFO *)packet;
+        DISPLAYCONFIG_GET_ADVANCED_COLOR_INFO *color_info = (DISPLAYCONFIG_GET_ADVANCED_COLOR_INFO *)packet;
+        struct monitor *monitor;
         const char *env;
-        static int once;
 
-        if (!once++)
-            FIXME( "DISPLAYCONFIG_DEVICE_INFO_GET_ADVANCED_COLOR_INFO semi-stub.\n" );
+        FIXME( "DISPLAYCONFIG_DEVICE_INFO_GET_ADVANCED_COLOR_INFO semi-stub.\n" );
 
-        if (packet->size < sizeof(*info))
+        if (packet->size < sizeof(*color_info))
             return STATUS_INVALID_PARAMETER;
 
-        info->advancedColorSupported = 0;
-        info->advancedColorEnabled = 0;
-        info->wideColorEnforced = 0;
-        info->advancedColorForceDisabled = 0;
-        info->colorEncoding = DISPLAYCONFIG_COLOR_ENCODING_RGB;
-        info->bitsPerColorChannel = 8;
         if ((env = getenv("DXVK_HDR")) && *env == '1')
         {
-            TRACE( "HDR is enabled.\n" );
-            info->advancedColorSupported = 1;
-            info->advancedColorEnabled = 1;
-            info->bitsPerColorChannel = 10;
+            color_info->advancedColorSupported = 1;
+            color_info->advancedColorEnabled = 1;
+            color_info->wideColorEnforced = 0;
+            color_info->advancedColorForceDisabled = 0;
+            color_info->colorEncoding = DISPLAYCONFIG_COLOR_ENCODING_RGB;
+            color_info->bitsPerColorChannel = 10;
+
+            return STATUS_SUCCESS;
         }
 
-        return STATUS_SUCCESS;
+        if (!lock_display_devices( FALSE )) return STATUS_UNSUCCESSFUL;
+
+        LIST_FOR_EACH_ENTRY(monitor, &monitors, struct monitor, entry)
+        {
+            if (color_info->header.id != monitor->output_id) continue;
+            if (memcmp( &color_info->header.adapterId, &monitor->source->gpu->luid,
+                        sizeof(monitor->source->gpu->luid) ))
+                continue;
+
+            color_info->advancedColorSupported = 0;
+            color_info->advancedColorEnabled = 0;
+            color_info->wideColorEnforced = 0;
+            color_info->advancedColorForceDisabled = 0;
+            color_info->colorEncoding = DISPLAYCONFIG_COLOR_ENCODING_RGB;
+            color_info->bitsPerColorChannel = 8;
+            ret = STATUS_SUCCESS;
+            break;
+        }
+
+        unlock_display_devices();
+        return ret;
     }
     case DISPLAYCONFIG_DEVICE_INFO_SET_TARGET_PERSISTENCE:
     case DISPLAYCONFIG_DEVICE_INFO_GET_TARGET_BASE_TYPE:
-- 
2.52.0

