From b831f562804a41862955c0775d1526c826c10a0e Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Sat, 4 Oct 2025 11:46:13 -0500
Subject: [PATCH 322/410] win32u: Ensure there is a composed character
 available.

---
 dlls/win32u/input.c                     | 6 ++----
 dlls/winewayland.drv/wayland_keyboard.c | 4 ++--
 2 files changed, 4 insertions(+), 6 deletions(-)

diff --git a/dlls/win32u/input.c b/dlls/win32u/input.c
index 7fcf1589e2a..26d09535121 100644
--- a/dlls/win32u/input.c
+++ b/dlls/win32u/input.c
@@ -1360,10 +1360,8 @@ INT WINAPI NtUserToUnicodeEx( UINT virt, UINT scan, const BYTE *state,
         if (key->dwBoth) str[0] = key->wchComposed;
         else
         {
-            if (size > 2) str[2] = 0;
-            str[1] = str[0];
-            str[0] = deadkey;
-            len = 2;
+            str[0] = 0;
+            len = 0;
         }
     }
 
diff --git a/dlls/winewayland.drv/wayland_keyboard.c b/dlls/winewayland.drv/wayland_keyboard.c
index 786e4347bf4..346596d0423 100644
--- a/dlls/winewayland.drv/wayland_keyboard.c
+++ b/dlls/winewayland.drv/wayland_keyboard.c
@@ -632,7 +632,7 @@ static void add_xkb_layout(const char *xkb_layout, struct xkb_keymap *xkb_keymap
             if (vkey2wch.wch[mod] != WCH_NONE) found = TRUE;
 
             keysym = xkb_state_key_get_one_sym(xkb_state, keyc);
-            if (keysym >= XKB_KEY_dead_grave && keysym <= XKB_KEY_dead_currency)
+            if (xkb_compose && keysym >= XKB_KEY_dead_grave && keysym <= XKB_KEY_dead_currency)
             {
                 vkey2wch.wch[mod] = WCH_DEAD;
                 dead_vkey2wch.wch[mod] = get_xkb_dead_key_char(keysym);
@@ -649,7 +649,7 @@ static void add_xkb_layout(const char *xkb_layout, struct xkb_keymap *xkb_keymap
             if (caps_vkey2wch.wch[mod] != WCH_NONE) caps_found = TRUE;
 
             keysym = xkb_state_key_get_one_sym(xkb_state, keyc);
-            if (keysym >= XKB_KEY_dead_grave && keysym <= XKB_KEY_dead_currency)
+            if (xkb_compose && keysym >= XKB_KEY_dead_grave && keysym <= XKB_KEY_dead_currency)
             {
                 caps_vkey2wch.wch[mod] = WCH_DEAD;
                 dead_caps_vkey2wch.wch[mod] = get_xkb_dead_key_char(keysym);
-- 
2.51.1

