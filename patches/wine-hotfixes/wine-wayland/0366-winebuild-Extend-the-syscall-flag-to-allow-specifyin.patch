From 31d0422ee1dad509da89a62b6c304717ae836dad Mon Sep 17 00:00:00 2001
From: Alexandre Julliard <julliard@winehq.org>
Date: Thu, 5 Jun 2025 11:59:40 +0200
Subject: [PATCH 366/409] winebuild: Extend the -syscall flag to allow
 specifying the syscall number.

---
 tools/winebuild/parser.c         |  9 +++++++++
 tools/winebuild/winebuild.man.in | 12 ++++--------
 2 files changed, 13 insertions(+), 8 deletions(-)

diff --git a/tools/winebuild/parser.c b/tools/winebuild/parser.c
index ec42c240a0a..4974faca2b0 100644
--- a/tools/winebuild/parser.c
+++ b/tools/winebuild/parser.c
@@ -507,6 +507,15 @@ static const char *parse_spec_flags( DLLSPEC *spec, ORDDEF *odp, const char *tok
             }
             free( args );
         }
+        else if (!strncmp( token, "syscall=", 8 ))
+        {
+            char *end;
+            unsigned int id = strtoul( token + 8, &end, 0 );
+
+            if (*end || id >= 0x4000)
+                error( "Invalid syscall number '%s', should be in range 0-0x3fff\n", token + 8 );
+            odp->flags |= FLAG_SYSCALL;
+        }
         else if (!strcmp( token, "i386" ))  /* backwards compatibility */
         {
             odp->flags |= FLAG_CPU(CPU_i386);
diff --git a/tools/winebuild/winebuild.man.in b/tools/winebuild/winebuild.man.in
index c09d2a2723a..73bcc836d12 100644
--- a/tools/winebuild/winebuild.man.in
+++ b/tools/winebuild/winebuild.man.in
@@ -248,11 +248,6 @@ argument array to use Unicode strings. A graphical executable has a
 Optionally a major and minor subsystem version can also be specified;
 the default subsystem version is 4.0.
 .TP
-.BI --syscall-table= id
-Set the system call table id, between 0 and 3. The default is 0, the
-ntdll syscall table. Only useful in modules that define syscall entry
-points.
-.TP
 .BI \-u,\ --undefined= symbol
 Add \fIsymbol\fR to the list of undefined symbols when invoking the
 linker. This makes it possible to force a specific module of a static
@@ -343,11 +338,12 @@ The function uses the
 calling convention (first two parameters in %ecx/%edx registers on
 i386).
 .TP
-.B -syscall
+.B -syscall\fR[=\fInumber\fR]
 The function is an NT system call. A system call thunk will be
 generated, and the actual function will be called by the
-\fI__wine_syscall_dispatcher\fR function that will be generated on the
-Unix library side.
+\fI__wine_syscall_dispatcher\fR function in ntdll. The system call
+number can be specified explicitly; by default it will be assigned
+sequentially starting from 0.
 .TP
 .B -import
 The function is imported from another module. This can be used instead
-- 
2.51.1

