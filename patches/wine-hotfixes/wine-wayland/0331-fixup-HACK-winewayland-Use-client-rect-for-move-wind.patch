From 51057aaa4e63c5b77c4b164f5423951ed266f092 Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Tue, 9 Sep 2025 17:16:52 -0500
Subject: [PATCH 331/336] fixup! HACK: winewayland: Use client rect for move
 window hack.

---
 dlls/win32u/window.c           | 55 +++++++++++++++++++++++-----------
 dlls/winewayland.drv/wayland.c |  2 +-
 2 files changed, 39 insertions(+), 18 deletions(-)

diff --git a/dlls/win32u/window.c b/dlls/win32u/window.c
index baa18b68ffb..ef2a715aa11 100644
--- a/dlls/win32u/window.c
+++ b/dlls/win32u/window.c
@@ -2085,6 +2085,23 @@ static void update_children_window_state( HWND hwnd )
     free( children );
 }
 
+static int move_hack_disabled(void)
+{
+    static volatile int disabled = -1;
+
+    if (disabled == -1)
+    {
+        const char *env = getenv("WINE_MOVE_HACK");
+
+        if (env && !strcmp(env, "0"))
+            disabled = 1;
+        else
+            disabled = 0;
+    }
+
+    return disabled;
+}
+
 /***********************************************************************
  *           apply_window_pos
  *
@@ -2103,47 +2120,51 @@ static BOOL apply_window_pos( HWND hwnd, HWND insert_after, UINT swp_flags, stru
     UINT raw_dpi_num, raw_dpi_den, monitor_dpi;
 
     /* HACK: move windows within the virtual screen on winewayland */
-    if (user_driver->pHasWindowManager("waylanddrv"))
+    if (user_driver->pHasWindowManager("waylanddrv") && !move_hack_disabled())
     {
-        RECT temp;
+        RECT temp, *adj;
         RECT virtual_screen = get_virtual_screen_rect( get_thread_dpi(), MDT_DEFAULT );
 
         adjusted = *new_rects;
+        adj = &adjusted.client;
 
-        intersect_rect(&temp, &virtual_screen, &adjusted.window);
+        intersect_rect(&temp, &virtual_screen, adj);
 
         /* we aren't off screen */
         if (!IsRectEmpty(&temp))
         {
             LONG offset_x = 0, offset_y = 0;
 
-            if (adjusted.window.bottom - adjusted.window.top <=
+            if (adj->bottom - adj->top <=
                 virtual_screen.bottom - virtual_screen.top)
             {
-                if (adjusted.window.bottom > virtual_screen.bottom)
-                    offset_y = virtual_screen.bottom - adjusted.window.bottom;
-                else if (virtual_screen.top > adjusted.window.top)
-                    offset_y = virtual_screen.top - adjusted.window.top;
+                if (adj->bottom > virtual_screen.bottom)
+                    offset_y = virtual_screen.bottom - adj->bottom;
+                else if (virtual_screen.top > adj->top)
+                    offset_y = virtual_screen.top - adj->top;
             }
 
-            if (adjusted.window.right - adjusted.window.left <=
+            if (adj->right - adj->left <=
                 virtual_screen.right - virtual_screen.left)
             {
-                if (adjusted.window.right > virtual_screen.right)
-                    offset_x = virtual_screen.right - adjusted.window.right;
-                else if (virtual_screen.left > adjusted.window.left)
-                    offset_x = virtual_screen.left - adjusted.window.left;
+                if (adj->right > virtual_screen.right)
+                    offset_x = virtual_screen.right - adj->right;
+                else if (virtual_screen.left > adj->left)
+                    offset_x = virtual_screen.left - adj->left;
             }
 
-
             OffsetRect(&adjusted.client, offset_x, offset_y);
             OffsetRect(&adjusted.visible, offset_x, offset_y);
             OffsetRect(&adjusted.window, offset_x, offset_y);
 
-            TRACE("Adjusted window rects: %s\n", debugstr_window_rects(&adjusted));
-            TRACE("Original window rects: %s\n", debugstr_window_rects(new_rects));
+            if (offset_x != 0 || offset_y != 0)
+            {
+                TRACE("virtual_screen %s\n", wine_dbgstr_rect(&virtual_screen));
+                TRACE("Original window rects: %s\n", debugstr_window_rects(new_rects));
+                TRACE("Adjusted window rects: %s\n", debugstr_window_rects(&adjusted));
 
-            new_rects = &adjusted;
+                new_rects = &adjusted;
+            }
         }
     }
 
diff --git a/dlls/winewayland.drv/wayland.c b/dlls/winewayland.drv/wayland.c
index cdb30de062a..96951385147 100644
--- a/dlls/winewayland.drv/wayland.c
+++ b/dlls/winewayland.drv/wayland.c
@@ -88,7 +88,7 @@ static const struct wl_seat_listener seat_listener =
 
 static BOOL check_ime_disabled(void)
 {
-    static int cached = -1;
+    static volatile int cached = -1;
 
     if (cached == -1)
     {
-- 
2.51.0

