From 22491cfe7f7e2f427c5d72328795f46ac7c085d2 Mon Sep 17 00:00:00 2001
From: Alexandre Julliard <julliard@winehq.org>
Date: Sun, 18 May 2025 12:07:18 +0200
Subject: [PATCH 339/378] include: Output the name label directly in the
 __ASM_GLOBL macro.

---
 dlls/msvcp90/cxx.h              | 6 ++----
 dlls/msvcrt/cxx.h               | 6 ++----
 dlls/ntdll/unix/signal_i386.c   | 6 ++----
 dlls/ntdll/unix/signal_x86_64.c | 6 ++----
 include/wine/asm.h              | 7 +++----
 5 files changed, 11 insertions(+), 20 deletions(-)

diff --git a/dlls/msvcp90/cxx.h b/dlls/msvcp90/cxx.h
index 8037d7def56..a0cec94af2f 100644
--- a/dlls/msvcp90/cxx.h
+++ b/dlls/msvcp90/cxx.h
@@ -35,8 +35,7 @@
     __asm__(".data\n" \
             "\t.balign 8\n" \
             "\t.quad " __ASM_NAME(#name "_rtti") "\n" \
-            "\t.globl " __ASM_NAME(#name "_vtable") "\n" \
-            __ASM_NAME(#name "_vtable") ":\n" \
+            __ASM_GLOBL(__ASM_NAME(#name "_vtable")) "\n" \
             funcs "\n\t.text")
 
 #else
@@ -47,8 +46,7 @@
     __asm__(".data\n" \
             "\t.balign 4\n" \
             "\t.long " __ASM_NAME(#name "_rtti") "\n" \
-            "\t.globl " __ASM_NAME(#name "_vtable") "\n" \
-            __ASM_NAME(#name "_vtable") ":\n" \
+            __ASM_GLOBL(__ASM_NAME(#name "_vtable")) "\n" \
             funcs "\n\t.text")
 
 #endif /* _WIN64 */
diff --git a/dlls/msvcrt/cxx.h b/dlls/msvcrt/cxx.h
index 8037d7def56..a0cec94af2f 100644
--- a/dlls/msvcrt/cxx.h
+++ b/dlls/msvcrt/cxx.h
@@ -35,8 +35,7 @@
     __asm__(".data\n" \
             "\t.balign 8\n" \
             "\t.quad " __ASM_NAME(#name "_rtti") "\n" \
-            "\t.globl " __ASM_NAME(#name "_vtable") "\n" \
-            __ASM_NAME(#name "_vtable") ":\n" \
+            __ASM_GLOBL(__ASM_NAME(#name "_vtable")) "\n" \
             funcs "\n\t.text")
 
 #else
@@ -47,8 +46,7 @@
     __asm__(".data\n" \
             "\t.balign 4\n" \
             "\t.long " __ASM_NAME(#name "_rtti") "\n" \
-            "\t.globl " __ASM_NAME(#name "_vtable") "\n" \
-            __ASM_NAME(#name "_vtable") ":\n" \
+            __ASM_GLOBL(__ASM_NAME(#name "_vtable")) "\n" \
             funcs "\n\t.text")
 
 #endif /* _WIN64 */
diff --git a/dlls/ntdll/unix/signal_i386.c b/dlls/ntdll/unix/signal_i386.c
index d1de0421081..0e7f5b0d5fe 100644
--- a/dlls/ntdll/unix/signal_i386.c
+++ b/dlls/ntdll/unix/signal_i386.c
@@ -2709,8 +2709,7 @@ __ASM_GLOBAL_FUNC( __wine_syscall_dispatcher,
                    __ASM_CFI(".cfi_adjust_cfa_offset 4\n\t")
                    "popl 0x04(%ecx)\n\t"           /* frame->eflags */
                    __ASM_CFI(".cfi_adjust_cfa_offset -4\n\t")
-                   __ASM_GLOBL(__ASM_NAME("__wine_syscall_dispatcher_prolog_end")) "\n"
-                   __ASM_NAME("__wine_syscall_dispatcher_prolog_end") ":\n\t"
+                   __ASM_GLOBL(__ASM_NAME("__wine_syscall_dispatcher_prolog_end")) "\n\t"
                    "movl %esp,0x0c(%ecx)\n\t"      /* frame->esp */
                    __ASM_CFI_CFA_IS_AT1(ecx, 0x0c)
                    "movw %cs,0x10(%ecx)\n\t"
@@ -2898,8 +2897,7 @@ __ASM_GLOBAL_FUNC( __wine_unix_call_dispatcher,
                    "popl 0x08(%ecx)\n\t"       /* frame->eip */
                    __ASM_CFI(".cfi_adjust_cfa_offset -4\n\t")
                    __ASM_CFI_REG_IS_AT1(eip, ecx, 0x08)
-                   __ASM_GLOBL(__ASM_NAME("__wine_unix_call_dispatcher_prolog_end")) "\n"
-                   __ASM_NAME("__wine_unix_call_dispatcher_prolog_end") ":\n\t"
+                   __ASM_GLOBL(__ASM_NAME("__wine_unix_call_dispatcher_prolog_end")) "\n\t"
                    "leal 0x10(%esp),%edx\n\t"
                    "movl %edx,0x0c(%ecx)\n\t"  /* frame->esp */
                    __ASM_CFI_CFA_IS_AT1(ecx, 0x0c)
diff --git a/dlls/ntdll/unix/signal_x86_64.c b/dlls/ntdll/unix/signal_x86_64.c
index 11e8b4bd592..859b57f76dc 100644
--- a/dlls/ntdll/unix/signal_x86_64.c
+++ b/dlls/ntdll/unix/signal_x86_64.c
@@ -3611,11 +3611,9 @@ __ASM_GLOBAL_FUNC( __wine_unix_call_dispatcher,
                    "ret" )
 
 asm( ".data\n\t"
-     __ASM_GLOBL(__ASM_NAME("__wine_syscall_dispatcher_prolog_end_ptr")) "\n"
-     __ASM_NAME("__wine_syscall_dispatcher_prolog_end_ptr") ":\n\t"
+     __ASM_GLOBL(__ASM_NAME("__wine_syscall_dispatcher_prolog_end_ptr")) "\n\t"
      ".quad " __ASM_LOCAL_LABEL("__wine_syscall_dispatcher_prolog_end") "\n\t"
-     __ASM_GLOBL(__ASM_NAME("__wine_unix_call_dispatcher_prolog_end_ptr")) "\n"
-     __ASM_NAME("__wine_unix_call_dispatcher_prolog_end_ptr") ":\n\t"
+     __ASM_GLOBL(__ASM_NAME("__wine_unix_call_dispatcher_prolog_end_ptr")) "\n\t"
      ".quad " __ASM_LOCAL_LABEL("__wine_unix_call_dispatcher_prolog_end") "\n\t"
      ".text\n\t" );
 
diff --git a/include/wine/asm.h b/include/wine/asm.h
index 836ba39923a..6fef6944afd 100644
--- a/include/wine/asm.h
+++ b/include/wine/asm.h
@@ -64,13 +64,13 @@
 #endif
 
 #ifdef __WINE_PE_BUILD
-# define __ASM_GLOBL(name) ".globl " name
+# define __ASM_GLOBL(name) ".globl " name "\n" name ":"
 # define __ASM_FUNC_SIZE(name) ""
 #elif defined(__APPLE__)
-# define __ASM_GLOBL(name) ".globl " name "\n\t.private_extern " name
+# define __ASM_GLOBL(name) ".globl " name "\n\t.private_extern " name "\n" name ":"
 # define __ASM_FUNC_SIZE(name) ""
 #else
-# define __ASM_GLOBL(name) ".globl " name "\n\t.hidden " name
+# define __ASM_GLOBL(name) ".globl " name "\n\t.hidden " name "\n" name ":"
 # define __ASM_FUNC_SIZE(name) ".size " name ",.-" name
 #endif
 
@@ -96,7 +96,6 @@
          __ASM_FUNC_ALIGN "\n\t" \
          __ASM_FUNC_TYPE(name) "\n" \
          __ASM_GLOBL(name) "\n\t" \
-         name ":\n\t" \
          __ASM_SEH(".seh_proc " name "\n\t") \
          __ASM_CFI(".cfi_startproc\n\t") \
          __ASM_EHABI(".fnstart\n\t") \
-- 
2.51.0

