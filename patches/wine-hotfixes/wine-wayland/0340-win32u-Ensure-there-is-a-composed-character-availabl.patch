From aca23981909219bb163b64c35ae27a4836f7b7c8 Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Sat, 4 Oct 2025 11:46:13 -0500
Subject: [PATCH 340/346] win32u: Ensure there is a composed character
 available.

---
 dlls/win32u/input.c                     | 6 ++----
 dlls/winewayland.drv/wayland_keyboard.c | 4 ++--
 2 files changed, 4 insertions(+), 6 deletions(-)

diff --git a/dlls/win32u/input.c b/dlls/win32u/input.c
index a39a1fb384b..5f62deb02f3 100644
--- a/dlls/win32u/input.c
+++ b/dlls/win32u/input.c
@@ -1362,10 +1362,8 @@ INT WINAPI NtUserToUnicodeEx( UINT virt, UINT scan, const BYTE *state,
         if (key->dwBoth) str[0] = key->wchComposed;
         else
         {
-            if (size > 2) str[2] = 0;
-            str[1] = str[0];
-            str[0] = deadkey;
-            len = 2;
+            str[0] = 0;
+            len = 0;
         }
     }
 
diff --git a/dlls/winewayland.drv/wayland_keyboard.c b/dlls/winewayland.drv/wayland_keyboard.c
index 3603a374c98..5896dec9bce 100644
--- a/dlls/winewayland.drv/wayland_keyboard.c
+++ b/dlls/winewayland.drv/wayland_keyboard.c
@@ -598,7 +598,7 @@ static void add_xkb_layout(const char *xkb_layout, struct xkb_keymap *xkb_keymap
             if (vkey2wch.wch[mod] != WCH_NONE) found = TRUE;
 
             keysym = xkb_state_key_get_one_sym(xkb_state, keyc);
-            if (keysym >= XKB_KEY_dead_grave && keysym <= XKB_KEY_dead_currency)
+            if (xkb_compose && keysym >= XKB_KEY_dead_grave && keysym <= XKB_KEY_dead_currency)
             {
                 vkey2wch.wch[mod] = WCH_DEAD;
                 dead_vkey2wch.wch[mod] = get_xkb_dead_key_char(keysym);
@@ -615,7 +615,7 @@ static void add_xkb_layout(const char *xkb_layout, struct xkb_keymap *xkb_keymap
             if (caps_vkey2wch.wch[mod] != WCH_NONE) caps_found = TRUE;
 
             keysym = xkb_state_key_get_one_sym(xkb_state, keyc);
-            if (keysym >= XKB_KEY_dead_grave && keysym <= XKB_KEY_dead_currency)
+            if (xkb_compose && keysym >= XKB_KEY_dead_grave && keysym <= XKB_KEY_dead_currency)
             {
                 caps_vkey2wch.wch[mod] = WCH_DEAD;
                 dead_caps_vkey2wch.wch[mod] = get_xkb_dead_key_char(keysym);
-- 
2.51.0

