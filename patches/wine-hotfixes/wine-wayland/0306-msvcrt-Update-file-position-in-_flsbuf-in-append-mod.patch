From 01e2bb4fecf84f2929e61b063e80a7e21719211d Mon Sep 17 00:00:00 2001
From: Piotr Caban <piotr@codeweavers.com>
Date: Mon, 24 Mar 2025 11:16:57 +0100
Subject: [PATCH 306/327] msvcrt: Update file position in _flsbuf() in append
 mode.

Wine-Bug: https://bugs.winehq.org/show_bug.cgi?id=56837
---
 dlls/msvcrt/file.c       |  2 ++
 dlls/msvcrt/tests/file.c | 14 +++++++++++---
 2 files changed, 13 insertions(+), 3 deletions(-)

diff --git a/dlls/msvcrt/file.c b/dlls/msvcrt/file.c
index 042915785db..6117de358b3 100644
--- a/dlls/msvcrt/file.c
+++ b/dlls/msvcrt/file.c
@@ -4118,6 +4118,8 @@ int CDECL _flsbuf(int c, FILE* file)
         int res = 0;
 
         if(file->_cnt <= 0) {
+            if(!file->_cnt && get_ioinfo_nolock(file->_file)->wxflag & WX_APPEND)
+                _lseek(file->_file, 0, FILE_END);
             res = msvcrt_flush_buffer(file);
             if(res)
                 return res;
diff --git a/dlls/msvcrt/tests/file.c b/dlls/msvcrt/tests/file.c
index 9ce3654bebe..6ead01e9e2d 100644
--- a/dlls/msvcrt/tests/file.c
+++ b/dlls/msvcrt/tests/file.c
@@ -695,11 +695,9 @@ static void test_fputc( void )
 
 static void test_flsbuf( void )
 {
+  int bufmode, ret, c, pos;
   char* tempf;
   FILE *tempfh;
-  int  c;
-  int  ret;
-  int  bufmode;
   static const int bufmodes[] = {_IOFBF,_IONBF};
 
   tempf=_tempnam(".","wne");
@@ -756,6 +754,16 @@ static void test_flsbuf( void )
   ok(c == EOF, "there should only be one byte\n");
   fclose(tempfh);
 
+  tempfh = fopen(tempf,"ab");
+  ok(tempfh != NULL, "fopen failed\n");
+  pos = _lseek(_fileno(tempfh), 0, SEEK_CUR);
+  ok(!pos, "incorrect stream position: %d\n", pos);
+  ret = _flsbuf(0, tempfh);
+  ok(!ret, "_flsbuf returned %x\n", ret);
+  pos = _lseek(_fileno(tempfh), 0, SEEK_CUR);
+  ok(pos == 1, "incorrect stream position: %d\n", pos);
+  fclose(tempfh);
+
   unlink(tempf);
   free(tempf);
 }
-- 
2.51.0

