From 0e2c36cf47b305292dc20c4618aec7607d8a62d6 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Bernhard=20=C3=9Cbelacker?= <bernhardu@mailbox.org>
Date: Wed, 14 May 2025 00:12:42 +0200
Subject: [PATCH 244/379] ntdll: Align records retrieved by
 SystemProcessInformation.

Wine-Bug: https://bugs.winehq.org/show_bug.cgi?id=55928
---
 dlls/ntdll/tests/info.c  | 2 ++
 dlls/ntdll/unix/system.c | 1 +
 dlls/wow64/system.c      | 1 +
 3 files changed, 4 insertions(+)

diff --git a/dlls/ntdll/tests/info.c b/dlls/ntdll/tests/info.c
index 4379af9af35..b1a24438fac 100644
--- a/dlls/ntdll/tests/info.c
+++ b/dlls/ntdll/tests/info.c
@@ -660,6 +660,8 @@ static void test_query_process( BOOL extended )
             }
         }
 
+        ok(((ULONG_PTR)spi & 7) == 0, "Record is not aligned at 8 byte boundary. %p\n", spi);
+
         if (!spi->NextEntryOffset)
         {
             winetest_pop_context();
diff --git a/dlls/ntdll/unix/system.c b/dlls/ntdll/unix/system.c
index 4d6cd7993a4..58acf1b7641 100644
--- a/dlls/ntdll/unix/system.c
+++ b/dlls/ntdll/unix/system.c
@@ -3105,6 +3105,7 @@ C_ASSERT( sizeof(struct process_info) <= sizeof(SYSTEM_PROCESS_INFORMATION) );
 
         proc_len = sizeof(*nt_process) + server_process->thread_count * thread_info_size
                      + (name_len + 1) * sizeof(WCHAR);
+        proc_len = (proc_len + 7) & ~(ULONG_PTR)7;
         *len += proc_len;
 
         if (*len <= size)
diff --git a/dlls/wow64/system.c b/dlls/wow64/system.c
index 5f3056a4179..3a79c83f629 100644
--- a/dlls/wow64/system.c
+++ b/dlls/wow64/system.c
@@ -177,6 +177,7 @@ static NTSTATUS put_system_proc_info( SYSTEM_PROCESS_INFORMATION32 *info32,
             prev = proc32;
         }
         outpos += proc_len + proc->ProcessName.MaximumLength;
+        outpos = (outpos + 7) & ~(ULONG_PTR)7;
         inpos += proc->NextEntryOffset;
         if (!proc->NextEntryOffset) break;
     }
-- 
2.51.0

