From fb3eca6cc9aa6d8c3e898802886f5fbb846c7d05 Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Thu, 27 Nov 2025 16:38:54 -0600
Subject: [PATCH 401/409] server/win32u: Implement cross thread get keyboard
 layout.

---
 dlls/win32u/defwnd.c           |  8 ++++++++
 dlls/win32u/input.c            | 20 ++++++++++++++++++--
 include/wine/server_protocol.h | 33 +++++++++++++++++++++++++++++++--
 server/protocol.def            | 12 ++++++++++++
 server/request_handlers.h      | 11 +++++++++++
 server/request_trace.h         | 22 ++++++++++++++++++++++
 server/thread.c                |  1 +
 server/thread.h                |  1 +
 server/winstation.c            | 21 +++++++++++++++++++++
 9 files changed, 125 insertions(+), 4 deletions(-)

diff --git a/dlls/win32u/defwnd.c b/dlls/win32u/defwnd.c
index a00648ded8c..06e28f1c977 100644
--- a/dlls/win32u/defwnd.c
+++ b/dlls/win32u/defwnd.c
@@ -2971,6 +2971,14 @@ LRESULT default_window_proc( HWND hwnd, UINT msg, WPARAM wparam, LPARAM lparam,
             int count = 0;
             info->kbd_layout = (HKL)lparam;
 
+            SERVER_START_REQ(set_thread_layout)
+            {
+                req->tid = GetCurrentThreadId();
+                req->layout = wine_server_client_ptr( info->kbd_layout );
+                wine_server_call(req);
+            }
+            SERVER_END_REQ;
+
             if (!win_array)
                 break;
             while (win_array[count])
diff --git a/dlls/win32u/input.c b/dlls/win32u/input.c
index 9a30fd049db..a7ecd7b2372 100644
--- a/dlls/win32u/input.c
+++ b/dlls/win32u/input.c
@@ -1022,10 +1022,18 @@ static HKL get_locale_kbd_layout(void)
 HKL WINAPI NtUserGetKeyboardLayout( DWORD thread_id )
 {
     struct user_thread_info *thread = get_user_thread_info();
-    HKL layout = thread->kbd_layout;
+    HKL layout = NULL;
 
     if (thread_id && thread_id != GetCurrentThreadId())
-        FIXME( "couldn't return keyboard layout for thread %04x\n", (int)thread_id );
+    {
+        SERVER_START_REQ(get_thread_layout)
+        {
+            req->tid = thread_id;
+            if (!wine_server_call(req))
+                layout = wine_server_get_ptr(reply->layout);
+        }
+        SERVER_END_REQ;
+    } else layout = thread->kbd_layout;
 
     if (!layout) return get_locale_kbd_layout();
     return layout;
@@ -1428,6 +1436,14 @@ HKL WINAPI NtUserActivateKeyboardLayout( HKL layout, UINT flags )
         info->kbd_layout = layout;
         info->kbd_layout_id = 0;
 
+        SERVER_START_REQ(set_thread_layout)
+        {
+            req->tid = GetCurrentThreadId();
+            req->layout = wine_server_client_ptr(layout);
+            wine_server_call(req);
+        }
+        SERVER_END_REQ;
+
         if (ime_hwnd) send_message( ime_hwnd, WM_IME_INTERNAL, IME_INTERNAL_HKL_ACTIVATE, HandleToUlong(layout) );
 
         if ((focus = get_focus()) && get_window_thread( focus, NULL ) == GetCurrentThreadId())
diff --git a/include/wine/server_protocol.h b/include/wine/server_protocol.h
index 0d9bde785b9..4c8738eff39 100644
--- a/include/wine/server_protocol.h
+++ b/include/wine/server_protocol.h
@@ -1002,7 +1002,7 @@ typedef volatile struct
     int                  cursor_count;
     unsigned char        keystate[256];
     int                  keystate_lock;
-    unsigned __int64     desktop_keystate_serial;
+    unsigned __int64     keystate_serial;
 } input_shm_t;
 
 typedef volatile union
@@ -4135,6 +4135,29 @@ struct get_thread_desktop_reply
 };
 
 
+struct get_thread_layout_request
+{
+    struct request_header __header;
+    thread_id_t tid;
+};
+struct get_thread_layout_reply
+{
+    struct reply_header __header;
+    client_ptr_t layout;
+};
+
+
+struct set_thread_layout_request
+{
+    struct request_header __header;
+    thread_id_t tid;
+    client_ptr_t layout;
+};
+struct set_thread_layout_reply
+{
+    struct reply_header __header;
+};
+
 
 struct set_thread_desktop_request
 {
@@ -6438,6 +6461,8 @@ enum request
     REQ_set_input_desktop,
     REQ_close_desktop,
     REQ_get_thread_desktop,
+    REQ_get_thread_layout,
+    REQ_set_thread_layout,
     REQ_set_thread_desktop,
     REQ_set_user_object_info,
     REQ_register_hotkey,
@@ -6758,6 +6783,8 @@ union generic_request
     struct set_input_desktop_request set_input_desktop_request;
     struct close_desktop_request close_desktop_request;
     struct get_thread_desktop_request get_thread_desktop_request;
+    struct get_thread_layout_request get_thread_layout_request;
+    struct set_thread_layout_request set_thread_layout_request;
     struct set_thread_desktop_request set_thread_desktop_request;
     struct set_user_object_info_request set_user_object_info_request;
     struct register_hotkey_request register_hotkey_request;
@@ -7076,6 +7103,8 @@ union generic_reply
     struct set_input_desktop_reply set_input_desktop_reply;
     struct close_desktop_reply close_desktop_reply;
     struct get_thread_desktop_reply get_thread_desktop_reply;
+    struct get_thread_layout_reply get_thread_layout_reply;
+    struct set_thread_layout_reply set_thread_layout_reply;
     struct set_thread_desktop_reply set_thread_desktop_reply;
     struct set_user_object_info_reply set_user_object_info_reply;
     struct register_hotkey_reply register_hotkey_reply;
@@ -7208,6 +7237,6 @@ union generic_reply
     struct get_inproc_alert_event_reply get_inproc_alert_event_reply;
 };
 
-#define SERVER_PROTOCOL_VERSION 863
+#define SERVER_PROTOCOL_VERSION 864
 
 #endif /* __WINE_WINE_SERVER_PROTOCOL_H */
diff --git a/server/protocol.def b/server/protocol.def
index 39c8d697284..6b797f7ec40 100644
--- a/server/protocol.def
+++ b/server/protocol.def
@@ -3015,6 +3015,18 @@ enum coords_relative
     obj_handle_t   handle;        /* handle to the desktop */
 @END
 
+/* Get the thread current keyboard layout */
+@REQ(get_thread_layout)
+    thread_id_t tid;              /* thread id */
+@REPLY
+    client_ptr_t layout;          /* keyboard layout HKL */
+@END
+
+/* Set the thread current keyboard layout */
+@REQ(set_thread_layout)
+    thread_id_t tid;              /* thread id */
+    client_ptr_t layout;          /* keyboard layout HKL */
+@END
 
 /* Set the thread current desktop */
 @REQ(set_thread_desktop)
diff --git a/server/request_handlers.h b/server/request_handlers.h
index 7505478384c..e449c0ce51c 100644
--- a/server/request_handlers.h
+++ b/server/request_handlers.h
@@ -190,6 +190,8 @@ DECL_HANDLER(open_input_desktop);
 DECL_HANDLER(set_input_desktop);
 DECL_HANDLER(close_desktop);
 DECL_HANDLER(get_thread_desktop);
+DECL_HANDLER(get_thread_layout);
+DECL_HANDLER(set_thread_layout);
 DECL_HANDLER(set_thread_desktop);
 DECL_HANDLER(set_user_object_info);
 DECL_HANDLER(register_hotkey);
@@ -507,6 +509,8 @@ static const req_handler req_handlers[REQ_NB_REQUESTS] =
     (req_handler)req_set_input_desktop,
     (req_handler)req_close_desktop,
     (req_handler)req_get_thread_desktop,
+    (req_handler)req_get_thread_layout,
+    (req_handler)req_set_thread_layout,
     (req_handler)req_set_thread_desktop,
     (req_handler)req_set_user_object_info,
     (req_handler)req_register_hotkey,
@@ -1731,6 +1735,13 @@ C_ASSERT( sizeof(struct get_thread_desktop_request) == 16 );
 C_ASSERT( offsetof(struct get_thread_desktop_reply, locator) == 8 );
 C_ASSERT( offsetof(struct get_thread_desktop_reply, handle) == 24 );
 C_ASSERT( sizeof(struct get_thread_desktop_reply) == 32 );
+C_ASSERT( offsetof(struct get_thread_layout_request, tid) == 12 );
+C_ASSERT( sizeof(struct get_thread_layout_request) == 16 );
+C_ASSERT( offsetof(struct get_thread_layout_reply, layout) == 8 );
+C_ASSERT( sizeof(struct get_thread_layout_reply) == 16 );
+C_ASSERT( offsetof(struct set_thread_layout_request, tid) == 12 );
+C_ASSERT( offsetof(struct set_thread_layout_request, layout) == 16 );
+C_ASSERT( sizeof(struct set_thread_layout_request) == 24 );
 C_ASSERT( offsetof(struct set_thread_desktop_request, handle) == 12 );
 C_ASSERT( sizeof(struct set_thread_desktop_request) == 16 );
 C_ASSERT( offsetof(struct set_thread_desktop_reply, locator) == 8 );
diff --git a/server/request_trace.h b/server/request_trace.h
index be58b020fb0..29f023763a8 100644
--- a/server/request_trace.h
+++ b/server/request_trace.h
@@ -2163,6 +2163,22 @@ static void dump_get_thread_desktop_reply( const struct get_thread_desktop_reply
     fprintf( stderr, ", handle=%04x", req->handle );
 }
 
+static void dump_get_thread_layout_request( const struct get_thread_layout_request *req )
+{
+    fprintf( stderr, " tid=%04x", req->tid );
+}
+
+static void dump_get_thread_layout_reply( const struct get_thread_layout_reply *req )
+{
+    dump_uint64( " layout=", &req->layout );
+}
+
+static void dump_set_thread_layout_request( const struct set_thread_layout_request *req )
+{
+    fprintf( stderr, " tid=%04x", req->tid );
+    dump_uint64( ", layout=", &req->layout );
+}
+
 static void dump_set_thread_desktop_request( const struct set_thread_desktop_request *req )
 {
     fprintf( stderr, " handle=%04x", req->handle );
@@ -3762,6 +3778,8 @@ static const dump_func req_dumpers[REQ_NB_REQUESTS] =
     (dump_func)dump_set_input_desktop_request,
     (dump_func)dump_close_desktop_request,
     (dump_func)dump_get_thread_desktop_request,
+    (dump_func)dump_get_thread_layout_request,
+    (dump_func)dump_set_thread_layout_request,
     (dump_func)dump_set_thread_desktop_request,
     (dump_func)dump_set_user_object_info_request,
     (dump_func)dump_register_hotkey_request,
@@ -4079,6 +4097,8 @@ static const dump_func reply_dumpers[REQ_NB_REQUESTS] =
     NULL,
     NULL,
     (dump_func)dump_get_thread_desktop_reply,
+    (dump_func)dump_get_thread_layout_reply,
+    NULL,
     (dump_func)dump_set_thread_desktop_reply,
     (dump_func)dump_set_user_object_info_reply,
     (dump_func)dump_register_hotkey_reply,
@@ -4396,6 +4416,8 @@ static const char * const req_names[REQ_NB_REQUESTS] =
     "set_input_desktop",
     "close_desktop",
     "get_thread_desktop",
+    "get_thread_layout",
+    "set_thread_layout",
     "set_thread_desktop",
     "set_user_object_info",
     "register_hotkey",
diff --git a/server/thread.c b/server/thread.c
index 28e49a09bed..4fdfa610044 100644
--- a/server/thread.c
+++ b/server/thread.c
@@ -316,6 +316,7 @@ static inline void init_thread_structure( struct thread *thread )
     thread->desc_len        = 0;
     thread->inproc_sync     = create_inproc_event( TRUE, FALSE );
     thread->inproc_alert_event = NULL;
+    thread->layout = 0;
 
     thread->creation_time = current_time;
     thread->exit_time     = 0;
diff --git a/server/thread.h b/server/thread.h
index 4b21eea2238..2462ba04571 100644
--- a/server/thread.h
+++ b/server/thread.h
@@ -90,6 +90,7 @@ struct thread
     int                    dbg_hidden;    /* hidden from debugger */
     int                    bypass_proc_suspend; /* will still run if the process is suspended */
     obj_handle_t           desktop;       /* desktop handle */
+    client_ptr_t           layout;        /* keyboard layout handle */
     int                    desktop_users; /* number of objects using the thread desktop */
     timeout_t              creation_time; /* Thread creation time */
     timeout_t              exit_time;     /* Thread exit time */
diff --git a/server/winstation.c b/server/winstation.c
index ad4664e2b1e..fd2458c63a0 100644
--- a/server/winstation.c
+++ b/server/winstation.c
@@ -831,6 +831,27 @@ DECL_HANDLER(get_thread_desktop)
     release_object( thread );
 }
 
+/* get the thread current keyboard layout */
+DECL_HANDLER(get_thread_layout)
+{
+    struct thread *thread;
+
+    if (!(thread = get_thread_from_id( req->tid ))) return;
+    reply->layout = thread->layout;
+
+    release_object( thread );
+}
+
+/* set the thread current keyboard layout */
+DECL_HANDLER(set_thread_layout)
+{
+    struct thread *thread;
+
+    if (!(thread = get_thread_from_id( req->tid ))) return;
+    thread->layout = req->layout;
+
+    release_object( thread );
+}
 
 /* set the thread current desktop */
 DECL_HANDLER(set_thread_desktop)
-- 
2.51.1

