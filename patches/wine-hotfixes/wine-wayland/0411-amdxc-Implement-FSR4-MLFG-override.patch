From 98fc79c5d8513d82384bd021a4978680786da745 Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Wed, 10 Dec 2025 19:25:44 -0600
Subject: [PATCH 411/473] amdxc: Implement FSR4 MLFG override.

---
 dlls/amdxc64/main.c | 70 ++++++++++++++++++++++++++++++++++++++-------
 1 file changed, 60 insertions(+), 10 deletions(-)

diff --git a/dlls/amdxc64/main.c b/dlls/amdxc64/main.c
index 72488c66dec..f2623c73fda 100644
--- a/dlls/amdxc64/main.c
+++ b/dlls/amdxc64/main.c
@@ -143,15 +143,47 @@ HRESULT STDMETHODCALLTYPE AMDFSR4FFX_QueryInterface(IAmdExtFfxApi *iface, REFIID
     return E_NOINTERFACE;
 }
 
+/* maintain compat with older SDK 2.0.0 and older */
 typedef HRESULT (__stdcall *updateffxapi_pfn)(void*, unsigned int);
+/* SDK 2.1.0 requires this */
+typedef HRESULT (__stdcall *updateffxapi_pfn_ex)(void*, unsigned int, void*);
 
-HRESULT STDMETHODCALLTYPE AMDFSR4FFX_UpdateFfxApiProvider(IAmdExtFfxApi *iface, void* data, unsigned int size)
+struct ffxProvider
 {
-    static int once;
+    void *vtable;
+    volatile ULONG64 ref;
+    ULONG64 id;
+    ULONG64 effect_id;
+    const char* version;
+};
+
+static void dump_provider(struct ffxProvider *provider)
+{
+    if (!provider) return;
+
+    TRACE("returned provider: %p %I64x %I64x %I64x %s\n",
+          provider->vtable, provider->ref, provider->id,
+          provider->effect_id, debugstr_a(provider->version));
+}
+
+struct unk_data {
+    int unk[4];
+    struct unk_data *next;
+};
+
+HRESULT STDMETHODCALLTYPE AMDFSR4FFX_UpdateFfxApiProvider(IAmdExtFfxApi *iface, void *_data, unsigned int size)
+{
+    struct AMDFSR4FFX *this = impl_from_IAmdExtFfxApi(iface);
+    struct ffxProvider *data = _data;
+    /* required to expose MLFG support */
+    struct unk_data unk_data[1] =
+    {
+        {{0, 1, 1, 0}, NULL}
+    };
     const char *env;
+    updateffxapi_pfn_ex pfn_ex;
     updateffxapi_pfn pfn;
     HMODULE amdffx;
-    struct AMDFSR4FFX *this = impl_from_IAmdExtFfxApi(iface);
 
     TRACE("%p %p %u\n", iface, data, size);
 
@@ -172,13 +204,27 @@ HRESULT STDMETHODCALLTYPE AMDFSR4FFX_UpdateFfxApiProvider(IAmdExtFfxApi *iface,
             return E_NOINTERFACE;
         }
 
+        pfn_ex = (updateffxapi_pfn_ex)GetProcAddress(amdffx, "UpdateFfxApiProviderEx");
         pfn = (updateffxapi_pfn)GetProcAddress(amdffx, "UpdateFfxApiProvider");
 
-        if (pfn)
+        if (pfn_ex)
+        {
+            HRESULT ret = pfn_ex(data, size, unk_data);
+
+            TRACE("status: %lx\n", ret);
+            dump_provider(data);
+
+            return ret;
+        } else if (pfn)
         {
-            if (!once++) WARN("Replaced FSR3 with FSR4!\n");
-            return pfn(data, size);
+            HRESULT ret = pfn(data, size);
+
+            TRACE("status: %lx\n", ret);
+            dump_provider(data);
+
+            return ret;
         }
+        else ERR("UpdateFfxApiProvider[Ex] symbol not found!\n");
     }
 
     return E_NOINTERFACE;
@@ -384,9 +430,13 @@ HRESULT STDMETHODCALLTYPE AmdExtD3DDevice8_GetWaveMatrixProperties(IAmdExtD3DDev
                                                                    SIZE_T *pCount, AmdExtWaveMatrixProperties *pProperties)
 {
     struct AmdExtD3DDevice8 *this = impl_from_IAmdExtD3DDevice8(iface);
-    static AmdExtWaveMatrixProperties prop[1] = {{
-        16, 16, 16, AMD_EXT_WMMA_TYPE_FP8, AMD_EXT_WMMA_TYPE_FP8,
-        AMD_EXT_WMMA_TYPE_FP32, AMD_EXT_WMMA_TYPE_FP32, FALSE}};
+    static AmdExtWaveMatrixProperties prop[1] =
+    {
+        {
+            16, 16, 16, AMD_EXT_WMMA_TYPE_FP8, AMD_EXT_WMMA_TYPE_FP8,
+            AMD_EXT_WMMA_TYPE_FP32, AMD_EXT_WMMA_TYPE_FP32, FALSE
+        }
+    };
 
     TRACE("%p %p %p\n", iface, pCount, pProperties);
 
@@ -507,7 +557,7 @@ HRESULT CDECL AmdExtD3DCreateInterface(IUnknown *outer, REFIID iid, void **obj)
         return S_OK;
     } else if (IsEqualGUID(iid, &IID_IAmdExtAntiLagApi)) {
         return ID3D12Device_QueryInterface((ID3D12Device *)outer, &IID_IAmdExtAntiLagApi, obj);
-    } else if(IsEqualGUID(iid, &IID_IAmdExtD3DFactory)) {
+    } else if (IsEqualGUID(iid, &IID_IAmdExtD3DFactory)) {
         struct AmdExtD3DFactory *this = calloc(1, sizeof(struct AmdExtD3DFactory));
         this->IAmdExtD3DFactory_iface.lpVtbl = &AmdExtD3DFactory_vtable;
         this->ref = 1;
-- 
2.52.0

