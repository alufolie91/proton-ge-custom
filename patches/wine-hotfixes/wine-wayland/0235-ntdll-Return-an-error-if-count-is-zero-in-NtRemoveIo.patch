From a8768a17646431ac9688ca7d9b6f5bb972d5d9cf Mon Sep 17 00:00:00 2001
From: Alex Henrie <alexhenrie24@gmail.com>
Date: Tue, 7 Jan 2025 00:20:45 -0700
Subject: [PATCH 235/378] ntdll: Return an error if count is zero in
 NtRemoveIoCompletionEx.

Without this check, the return value is undefined.
---
 dlls/ntdll/tests/file.c | 5 +++++
 dlls/ntdll/unix/sync.c  | 3 +++
 dlls/wow64/file.c       | 6 +++++-
 3 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/dlls/ntdll/tests/file.c b/dlls/ntdll/tests/file.c
index dbb62578d60..85dbd1c010a 100644
--- a/dlls/ntdll/tests/file.c
+++ b/dlls/ntdll/tests/file.c
@@ -1082,6 +1082,11 @@ static void test_set_io_completion(void)
         return;
     }
 
+    count = 0xdeadbeef;
+    res = pNtRemoveIoCompletionEx( h, info, 0, &count, &timeout, FALSE );
+    ok( res == STATUS_INVALID_PARAMETER, "NtRemoveIoCompletionEx failed: %#lx\n", res );
+    ok( count == 0xdeadbeef, "wrong count %lu\n", count );
+
     count = 0xdeadbeef;
     res = pNtRemoveIoCompletionEx( h, info, 2, &count, &timeout, FALSE );
     ok( res == STATUS_TIMEOUT, "NtRemoveIoCompletionEx failed: %#lx\n", res );
diff --git a/dlls/ntdll/unix/sync.c b/dlls/ntdll/unix/sync.c
index b587750c349..4f999054cfc 100644
--- a/dlls/ntdll/unix/sync.c
+++ b/dlls/ntdll/unix/sync.c
@@ -3197,6 +3197,9 @@ NTSTATUS WINAPI NtRemoveIoCompletionEx( HANDLE handle, FILE_IO_COMPLETION_INFORM
 
     TRACE( "%p %p %u %p %p %u\n", handle, info, (int)count, written, timeout, alertable );
 
+
+    if (!count) return STATUS_INVALID_PARAMETER;
+
     if (timeout && !timeout->QuadPart && (do_esync() || do_fsync()))
     {
         status = NtWaitForSingleObject( handle, alertable, timeout );
diff --git a/dlls/wow64/file.c b/dlls/wow64/file.c
index 0afd02a2a7c..d3358000def 100644
--- a/dlls/wow64/file.c
+++ b/dlls/wow64/file.c
@@ -751,7 +751,11 @@ NTSTATUS WINAPI wow64_NtRemoveIoCompletionEx( UINT *args )
 
     NTSTATUS status;
     ULONG i;
-    FILE_IO_COMPLETION_INFORMATION *info = Wow64AllocateTemp( count * sizeof(*info) );
+    FILE_IO_COMPLETION_INFORMATION *info;
+
+    if (!count) return STATUS_INVALID_PARAMETER;
+
+    info = Wow64AllocateTemp( count * sizeof(*info) );
 
     status = NtRemoveIoCompletionEx( handle, info, count, written, timeout, alertable );
     for (i = 0; i < *written; i++)
-- 
2.51.0

