From 76f959b885aa0c341ed4f16b23f2e6bbc3e4d627 Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Fri, 28 Nov 2025 16:47:34 -0500
Subject: [PATCH 405/473] winewayland: Send WM_CANCELMODE on leave.

Source: https://gitlab.winehq.org/wine/wine/-/merge_requests/6199#note_104335
---
 dlls/winewayland.drv/wayland_keyboard.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/dlls/winewayland.drv/wayland_keyboard.c b/dlls/winewayland.drv/wayland_keyboard.c
index 6fd7b709c67..4b7179e5445 100644
--- a/dlls/winewayland.drv/wayland_keyboard.c
+++ b/dlls/winewayland.drv/wayland_keyboard.c
@@ -992,6 +992,12 @@ static void keyboard_handle_leave(void *data, struct wl_keyboard *wl_keyboard,
      * and for any key repetition to stop. */
     release_all_keys(hwnd);
 
+    if (hwnd == NtUserGetForegroundWindow())
+    {
+        if (!(NtUserGetWindowLongW(hwnd, GWL_STYLE) & WS_MINIMIZE))
+            send_message(hwnd, WM_CANCELMODE, 0, 0);
+    }
+
     /* FIXME: update foreground window as well */
 }
 
-- 
2.52.0

