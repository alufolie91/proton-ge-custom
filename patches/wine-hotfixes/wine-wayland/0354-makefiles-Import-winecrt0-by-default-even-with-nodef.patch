From 1445c3627047c7dc509d7f7a512ceb365a2eb4fb Mon Sep 17 00:00:00 2001
From: Alexandre Julliard <julliard@winehq.org>
Date: Wed, 26 Feb 2025 17:02:19 +0100
Subject: [PATCH 354/378] makefiles: Import winecrt0 by default even with
 -nodefaultlibs.

---
 dlls/kernel32/Makefile.in   |  2 +-
 dlls/kernelbase/Makefile.in |  2 +-
 dlls/ntdll/Makefile.in      |  2 +-
 dlls/win32u/Makefile.in     |  2 +-
 dlls/wow64/Makefile.in      |  2 +-
 dlls/wow64cpu/Makefile.in   |  2 +-
 dlls/wow64win/Makefile.in   |  2 +-
 dlls/xtajit64/Makefile.in   |  2 +-
 tools/makedep.c             | 19 ++++++++++++++-----
 9 files changed, 22 insertions(+), 13 deletions(-)

diff --git a/dlls/kernel32/Makefile.in b/dlls/kernel32/Makefile.in
index ca5bb437e24..66cd9916673 100644
--- a/dlls/kernel32/Makefile.in
+++ b/dlls/kernel32/Makefile.in
@@ -1,7 +1,7 @@
 EXTRADEFS = -D_KERNEL32_ -D_NORMALIZE_
 MODULE    = kernel32.dll
 IMPORTLIB = kernel32
-IMPORTS   = kernelbase ntdll winecrt0
+IMPORTS   = kernelbase ntdll
 
 EXTRADLLFLAGS = -nodefaultlibs -Wb,-F,KERNEL32.dll
 i386_EXTRADLLFLAGS = -Wl,--image-base,0x7b800000
diff --git a/dlls/kernelbase/Makefile.in b/dlls/kernelbase/Makefile.in
index 081e9bfbb64..2e33b6b5801 100644
--- a/dlls/kernelbase/Makefile.in
+++ b/dlls/kernelbase/Makefile.in
@@ -1,7 +1,7 @@
 EXTRADEFS = -DWINBASEAPI= -DWINADVAPI= -DWINUSERAPI= -DWINSHLWAPI=
 MODULE    = kernelbase.dll
 IMPORTLIB = kernelbase
-IMPORTS   = uuid ntdll winecrt0
+IMPORTS   = uuid ntdll
 
 EXTRADLLFLAGS = -nodefaultlibs -nostartfiles
 i386_EXTRADLLFLAGS = -Wl,--image-base,0x7b000000
diff --git a/dlls/ntdll/Makefile.in b/dlls/ntdll/Makefile.in
index acc10f61fe9..3a91743a34c 100644
--- a/dlls/ntdll/Makefile.in
+++ b/dlls/ntdll/Makefile.in
@@ -2,7 +2,7 @@ EXTRADEFS = -D_NTSYSTEM_ -D_ACRTIMP= -DWINBASEAPI=
 MODULE    = ntdll.dll
 UNIXLIB   = ntdll.so
 IMPORTLIB = ntdll
-IMPORTS   = $(TOMCRYPT_PE_LIBS) $(MUSL_PE_LIBS) winecrt0
+IMPORTS   = $(TOMCRYPT_PE_LIBS) $(MUSL_PE_LIBS)
 EXTRAINCL = $(TOMCRYPT_PE_CFLAGS)
 UNIX_CFLAGS  = $(UNWIND_CFLAGS)
 UNIX_LIBS    = $(IOKIT_LIBS) $(COREFOUNDATION_LIBS) $(CORESERVICES_LIBS) $(RT_LIBS) $(PTHREAD_LIBS) $(UNWIND_LIBS) $(I386_LIBS) $(PROCSTAT_LIBS)
diff --git a/dlls/win32u/Makefile.in b/dlls/win32u/Makefile.in
index 6326a3cd302..c64f6bc6fb9 100644
--- a/dlls/win32u/Makefile.in
+++ b/dlls/win32u/Makefile.in
@@ -2,7 +2,7 @@ EXTRADEFS = -D_WIN32U_
 MODULE    = win32u.dll
 UNIXLIB   = win32u.so
 IMPORTLIB = win32u
-IMPORTS   = ntdll winecrt0
+IMPORTS   = ntdll
 UNIX_CFLAGS  = $(FREETYPE_CFLAGS) $(FONTCONFIG_CFLAGS)
 UNIX_LIBS    = $(CARBON_LIBS) $(APPKIT_LIBS) $(PTHREAD_LIBS) -lm
 
diff --git a/dlls/wow64/Makefile.in b/dlls/wow64/Makefile.in
index b58b6eb803a..8453e8708c5 100644
--- a/dlls/wow64/Makefile.in
+++ b/dlls/wow64/Makefile.in
@@ -1,6 +1,6 @@
 MODULE    = wow64.dll
 IMPORTLIB = wow64
-IMPORTS   = ntdll winecrt0
+IMPORTS   = ntdll
 
 EXTRADLLFLAGS = -nodefaultlibs
 
diff --git a/dlls/wow64cpu/Makefile.in b/dlls/wow64cpu/Makefile.in
index b06fc8f9f64..b0bb8893d29 100644
--- a/dlls/wow64cpu/Makefile.in
+++ b/dlls/wow64cpu/Makefile.in
@@ -1,5 +1,5 @@
 MODULE    = wow64cpu.dll
-IMPORTS   = wow64 ntdll winecrt0
+IMPORTS   = wow64 ntdll
 
 EXTRADLLFLAGS = -nodefaultlibs -Wl,--image-base,0x7a400000
 
diff --git a/dlls/wow64win/Makefile.in b/dlls/wow64win/Makefile.in
index e4451cf7099..e38b54f68a2 100644
--- a/dlls/wow64win/Makefile.in
+++ b/dlls/wow64win/Makefile.in
@@ -1,5 +1,5 @@
 MODULE    = wow64win.dll
-IMPORTS   = wow64 win32u ntdll winecrt0
+IMPORTS   = wow64 win32u ntdll
 
 EXTRADLLFLAGS = -nodefaultlibs
 
diff --git a/dlls/xtajit64/Makefile.in b/dlls/xtajit64/Makefile.in
index 42b030303ba..e0b2276a530 100644
--- a/dlls/xtajit64/Makefile.in
+++ b/dlls/xtajit64/Makefile.in
@@ -1,5 +1,5 @@
 MODULE    = xtajit64.dll
-IMPORTS   = ntdll winecrt0
+IMPORTS   = ntdll
 EXTRADEFS = -D_CRTIMP=
 
 EXTRADLLFLAGS = -nodefaultlibs
diff --git a/tools/makedep.c b/tools/makedep.c
index 22a7c14710f..eb3105104c9 100644
--- a/tools/makedep.c
+++ b/tools/makedep.c
@@ -2269,12 +2269,21 @@ static const char *get_crt_define( const struct makefile *make )
 /*******************************************************************
  *         get_default_imports
  */
-static struct strarray get_default_imports( const struct makefile *make, struct strarray imports )
+static struct strarray get_default_imports( const struct makefile *make, struct strarray imports,
+                                            int nodefaultlibs )
 {
     struct strarray ret = empty_strarray;
     const char *crt_dll = get_default_crt( make );
     unsigned int i;
 
+    if (nodefaultlibs)
+    {
+        for (i = 0; i < imports.count; i++)
+            if (!strcmp( imports.str[i], "winecrt0" )) return ret;
+        strarray_add( &ret, "winecrt0" );
+        return ret;
+    }
+
     for (i = 0; i < imports.count; i++)
         if (is_crt_module( imports.str[i] ))
             crt_dll = imports.str[i];
@@ -3125,7 +3134,7 @@ static void output_source_testdll( struct makefile *make, struct incl_file *sour
     if (!imports.count) imports = make->imports;
     strarray_addall( &dll_flags, make->extradllflags );
     strarray_addall( &dll_flags, get_expanded_file_local_var( make, obj, "EXTRADLLFLAGS" ));
-    if (!strarray_exists( &dll_flags, "-nodefaultlibs" )) default_imports = get_default_imports( make, imports );
+    default_imports = get_default_imports( make, imports, strarray_exists( &dll_flags, "-nodefaultlibs" ));
     if (strarray_exists( &dll_flags, "-mconsole" )) ext = ".exe";
 
     for (arch = 0; arch < archs.count; arch++)
@@ -3477,8 +3486,8 @@ static void output_module( struct makefile *make, unsigned int arch )
         if (!get_link_arch( make, arch, &link_arch )) return;
 
         module_name = arch_module_name( module, arch );
-
-        if (!strarray_exists( &make->extradllflags, "-nodefaultlibs" )) default_imports = get_default_imports( make, imports );
+        default_imports = get_default_imports( make, imports,
+                                               strarray_exists( &make->extradllflags, "-nodefaultlibs" ));
 
         strarray_addall( &all_libs, add_import_libs( make, &dep_libs, imports, IMPORT_TYPE_DIRECT, arch ));
         strarray_addall( &all_libs, add_import_libs( make, &dep_libs, make->delayimports, IMPORT_TYPE_DELAYED, arch ));
@@ -3656,7 +3665,7 @@ static void output_test_module( struct makefile *make, unsigned int arch )
     char *basemodule = replace_extension( make->testdll, ".dll", "" );
     char *stripped = arch_module_name( strmake( "%s_test-stripped.exe", basemodule ), arch );
     char *testmodule = arch_module_name( strmake( "%s_test.exe", basemodule ), arch );
-    struct strarray default_imports = get_default_imports( make, make->imports );
+    struct strarray default_imports = get_default_imports( make, make->imports, 0 );
     struct strarray dep_libs = empty_strarray;
     struct strarray all_libs = empty_strarray;
     struct makefile *parent = get_parent_makefile( make );
-- 
2.51.0

