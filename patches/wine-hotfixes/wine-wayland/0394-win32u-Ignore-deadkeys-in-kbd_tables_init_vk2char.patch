From 93f2cee9f41629b4d55593ae17765c260c6bbcaf Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Wed, 19 Nov 2025 03:12:27 -0600
Subject: [PATCH 394/473] win32u: Ignore deadkeys in kbd_tables_init_vk2char.

---
 dlls/win32u/input.c | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

diff --git a/dlls/win32u/input.c b/dlls/win32u/input.c
index 6abeaf89109..9a30fd049db 100644
--- a/dlls/win32u/input.c
+++ b/dlls/win32u/input.c
@@ -447,7 +447,14 @@ static void kbd_tables_init_vk2char( const KBDTABLES *tables, BYTE vk2char[0x100
         for (entry = table->pVkToWchars; entry->VirtualKey; entry = NEXT_ENTRY(table, entry))
         {
             if (entry->VirtualKey & ~0xff) continue;
-            vk2char[entry->VirtualKey] = entry->wch[0];
+            if (entry->Attributes & SGCAPS) continue;
+            /*
+             * FIXME: implement dead keys
+             * MSDN says the top bit is set 1 in the return value of MAPVK_VK_TO_CHAR
+             */
+            /* don't overwrite an already set value */
+            if (entry->wch[0] & 0xff && entry->wch[0] != WCH_DEAD)
+                vk2char[entry->VirtualKey] = entry->wch[0];
         }
     }
 }
-- 
2.52.0

