From 5cf50debb027dcb766f0f0be6adde591d213e511 Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Wed, 26 Nov 2025 19:27:46 -0600
Subject: [PATCH 398/473] HACK: winewayland: Handle extended scancode->Vk
 mappings.

---
 dlls/winewayland.drv/wayland_keyboard.c | 29 ++++++++++++++++++++-----
 1 file changed, 24 insertions(+), 5 deletions(-)

diff --git a/dlls/winewayland.drv/wayland_keyboard.c b/dlls/winewayland.drv/wayland_keyboard.c
index 3f5fdda9e47..9c67cb8f8f9 100644
--- a/dlls/winewayland.drv/wayland_keyboard.c
+++ b/dlls/winewayland.drv/wayland_keyboard.c
@@ -1007,9 +1007,9 @@ static void keyboard_handle_key(void *data, struct wl_keyboard *wl_keyboard,
                                 uint32_t serial, uint32_t time, uint32_t key,
                                 uint32_t state)
 {
-    struct wayland_keyboard *keyboard = &process_wayland.keyboard;
     UINT scan = key2scan(key);
     INPUT input = {0};
+    const KBDTABLES *tables;
     HWND hwnd;
 
     InterlockedExchange(&process_wayland.input_serial, serial);
@@ -1028,12 +1028,31 @@ static void keyboard_handle_key(void *data, struct wl_keyboard *wl_keyboard,
 
     input.type = INPUT_KEYBOARD;
     input.ki.wScan = (scan & 0x300) ? scan + 0xdf00 : scan;
+    if (scan & ~0xff) input.ki.dwFlags |= KEYEVENTF_EXTENDEDKEY;
 
-    pthread_mutex_lock(&keyboard->mutex);
-    input.ki.wVk = NtUserMapVirtualKeyEx(input.ki.wScan, MAPVK_VSC_TO_VK_EX, keyboard_hkl);
-    pthread_mutex_unlock(&keyboard->mutex);
+    if ((tables = WAYLAND_KbdLayerDescriptor(keyboard_hkl)))
+    {
+        if (scan < 0x100)
+            input.ki.wVk = tables->pusVSCtoVK[scan];
+        else
+        {
+            const VSC_VK *entry;
+
+            for (entry = tables->pVSCtoVK_E0; entry && entry->Vsc && !input.ki.wVk; entry++)
+            {
+                if (entry->Vsc + 0x100 == scan)
+                    input.ki.wVk = entry->Vk;
+            }
+            for (entry = tables->pVSCtoVK_E1; entry && entry->Vsc && !input.ki.wVk; entry++)
+            {
+                if (entry->Vsc + 0x200 == scan)
+                    input.ki.wVk = entry->Vk;
+            }
+        }
+
+        WAYLAND_ReleaseKbdTables(tables);
+    } else input.ki.dwFlags |= KEYEVENTF_SCANCODE;
 
-    if (scan & ~0xff) input.ki.dwFlags |= KEYEVENTF_EXTENDEDKEY;
     if (state == WL_KEYBOARD_KEY_STATE_RELEASED) input.ki.dwFlags |= KEYEVENTF_KEYUP;
 
     NtUserSendHardwareInput(hwnd, 0, &input, 0);
-- 
2.52.0

