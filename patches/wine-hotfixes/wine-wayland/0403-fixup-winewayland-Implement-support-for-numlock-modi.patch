From ff032ee9ffb0bb38d277c1e5422ec5492a5f449c Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Fri, 28 Nov 2025 15:08:23 -0500
Subject: [PATCH 403/406] fixup! winewayland: Implement support for numlock
 modifier.

---
 dlls/winewayland.drv/wayland_keyboard.c | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/dlls/winewayland.drv/wayland_keyboard.c b/dlls/winewayland.drv/wayland_keyboard.c
index 6d8bd4f55c1..85e0809fe47 100644
--- a/dlls/winewayland.drv/wayland_keyboard.c
+++ b/dlls/winewayland.drv/wayland_keyboard.c
@@ -806,6 +806,8 @@ static void release_all_keys(HWND hwnd)
         if (vkey < 7 && vkey != VK_CANCEL) continue;
         /* Skip left/right-agnostic modifier vkeys. */
         if (vkey == VK_SHIFT || vkey == VK_CONTROL || vkey == VK_MENU) continue;
+        /* skip modifier keys we handle */
+        if (vkey == VK_NUMLOCK) continue;
 
         if (state[vkey] & 0x80)
         {
@@ -1008,13 +1010,17 @@ static void sync_mod_state(HWND hwnd)
     struct wayland_keyboard *keyboard = &process_wayland.keyboard;
     INPUT input = {0};
     BYTE state[256];
+    BOOL numlock_changed;
 
     input.type = INPUT_KEYBOARD;
     input.ki.dwFlags = KEYEVENTF_SCANCODE;
     if (!NtUserGetAsyncKeyboardState(state)) return;
 
     pthread_mutex_lock(&keyboard->mutex);
-    if (!!(state[VK_NUMLOCK] & 0x80) != keyboard->numlock_active)
+    numlock_changed = (!!(state[VK_NUMLOCK] & 0x80) != keyboard->numlock_active);
+    pthread_mutex_unlock(&keyboard->mutex);
+
+    if (numlock_changed)
     {
         input.ki.dwFlags |= KEYEVENTF_EXTENDEDKEY;
         input.ki.wScan = key2scan(KEY_NUMLOCK);
@@ -1022,7 +1028,6 @@ static void sync_mod_state(HWND hwnd)
 
         NtUserSendHardwareInput(hwnd, 0, &input, 0);
     }
-    pthread_mutex_unlock(&keyboard->mutex);
 }
 
 static void keyboard_handle_key(void *data, struct wl_keyboard *wl_keyboard,
-- 
2.51.1

