From a0efc8c20aede43a727c1fc2964961ef5f6c03f3 Mon Sep 17 00:00:00 2001
From: Alexandre Julliard <julliard@winehq.org>
Date: Mon, 31 Mar 2025 13:02:46 +0200
Subject: [PATCH 254/341] ntdll: Add a helper to build an NT name from the
 system directory.

---
 dlls/ntdll/loader.c     | 21 ++++++++++++---------
 dlls/ntdll/ntdll_misc.h |  1 -
 2 files changed, 12 insertions(+), 10 deletions(-)

diff --git a/dlls/ntdll/loader.c b/dlls/ntdll/loader.c
index 53fe85ef5d5..4526a7bba92 100644
--- a/dlls/ntdll/loader.c
+++ b/dlls/ntdll/loader.c
@@ -83,7 +83,7 @@ unixlib_handle_t __wine_unixlib_handle = 0;
 /* windows directory */
 const WCHAR windows_dir[] = L"C:\\windows";
 /* system directory with trailing backslash */
-const WCHAR system_dir[] = L"C:\\windows\\system32\\";
+static const WCHAR system_dir[] = L"C:\\windows\\system32\\";
 
 /* system search path */
 static const WCHAR system_path[] = L"C:\\windows\\system32;C:\\windows\\system;C:\\windows;C:\\Program Files (x86)\\Steam";
@@ -575,6 +575,16 @@ static ULONG hash_basename( const UNICODE_STRING *basename )
     return hash % HASH_MAP_SIZE;
 }
 
+/* build NT name for dll in system directory */
+static void build_sysdir_nt_name( const WCHAR *name, UNICODE_STRING *nt_name )
+{
+    nt_name->Length = (4 + wcslen(system_dir) + wcslen(name)) * sizeof(WCHAR);
+    nt_name->Buffer = RtlAllocateHeap( GetProcessHeap(), 0, nt_name->Length + sizeof(WCHAR) );
+    wcscpy( nt_name->Buffer, L"\\??\\" );
+    wcscat( nt_name->Buffer, system_dir );
+    wcscat( nt_name->Buffer, name );
+}
+
 /*************************************************************************
  *		get_modref
  *
@@ -3301,14 +3311,7 @@ static NTSTATUS find_builtin_without_file( const WCHAR *name, UNICODE_STRING *ne
 
 done:
     RtlFreeUnicodeString( new_name );
-    if (!status)
-    {
-        new_name->Length = (4 + wcslen(system_dir) + wcslen(name)) * sizeof(WCHAR);
-        new_name->Buffer = RtlAllocateHeap( GetProcessHeap(), 0, new_name->Length + sizeof(WCHAR) );
-        wcscpy( new_name->Buffer, L"\\??\\" );
-        wcscat( new_name->Buffer, system_dir );
-        wcscat( new_name->Buffer, name );
-    }
+    if (!status) build_sysdir_nt_name( name, new_name );
     return status;
 }
 
diff --git a/dlls/ntdll/ntdll_misc.h b/dlls/ntdll/ntdll_misc.h
index 3dae3079c4e..4da84de52c5 100644
--- a/dlls/ntdll/ntdll_misc.h
+++ b/dlls/ntdll/ntdll_misc.h
@@ -106,7 +106,6 @@ extern FARPROC SNOOP_GetProcAddress( HMODULE hmod, const IMAGE_EXPORT_DIRECTORY
 extern void RELAY_SetupDLL( HMODULE hmod );
 extern void SNOOP_SetupDLL( HMODULE hmod );
 extern const WCHAR windows_dir[];
-extern const WCHAR system_dir[];
 
 extern void (FASTCALL *pBaseThreadInitThunk)(DWORD,LPTHREAD_START_ROUTINE,void *);
 
-- 
2.50.1

