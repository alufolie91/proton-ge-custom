From 36dc1ed75feab1535679a07ce5715c0d586d8129 Mon Sep 17 00:00:00 2001
From: Mark Jansen <mark.jansen@reactos.org>
Date: Fri, 4 Nov 2022 19:17:37 +0100
Subject: [PATCH 342/365] kernelbase: Fix VerQueryValueW with no data.

---
 dlls/kernelbase/version.c | 7 ++++++-
 dlls/version/tests/info.c | 1 -
 2 files changed, 6 insertions(+), 2 deletions(-)

diff --git a/dlls/kernelbase/version.c b/dlls/kernelbase/version.c
index 268ccfcd570..4281a9ed019 100644
--- a/dlls/kernelbase/version.c
+++ b/dlls/kernelbase/version.c
@@ -1099,6 +1099,7 @@ static BOOL VersionInfo16_QueryValue( const VS_VERSION_INFO_STRUCT16 *info, LPCS
 static BOOL VersionInfo32_QueryValue( const VS_VERSION_INFO_STRUCT32 *info, LPCWSTR lpSubBlock,
                                       LPVOID *lplpBuffer, UINT *puLen, BOOL *pbText )
 {
+    PVOID ptr;
     TRACE("lpSubBlock : (%s)\n", debugstr_w(lpSubBlock));
 
     while ( *lpSubBlock )
@@ -1130,7 +1131,11 @@ static BOOL VersionInfo32_QueryValue( const VS_VERSION_INFO_STRUCT32 *info, LPCW
     }
 
     /* Return value */
-    *lplpBuffer = VersionInfo32_Value( info );
+    ptr = VersionInfo32_Value(info);
+    if ((PBYTE)ptr >= ((PBYTE)info + info->wLength))  /* empty value */
+        ptr = (WCHAR*)info->szKey + wcslen(info->szKey);
+
+    *lplpBuffer = ptr;
     if (puLen)
         *puLen = info->wValueLength;
     if (pbText)
diff --git a/dlls/version/tests/info.c b/dlls/version/tests/info.c
index 6b9cc0e7d89..8c6e7a54906 100644
--- a/dlls/version/tests/info.c
+++ b/dlls/version/tests/info.c
@@ -709,7 +709,6 @@ static void test_VerQueryValue_EmptyData(void)
     ret = VerQueryValueW(ver, L"\\StringFileInfo\\FFFF0000\\FileVersion", (LPVOID *)&p, &len);
     ok(ret, "VerQueryValueW error %lu\n", GetLastError());
     ok(len == 0, "VerQueryValueW returned %u, expected 0\n", len);
-    todo_wine
     ok(p == (ver + offsetof(rsrc_section_t, FileVersion_key) + 11 * sizeof(WCHAR)), "p was %p, expected %p\n", p, ver + offsetof(rsrc_section_t, FileVersion_key) + 11 * sizeof(WCHAR));
 
     /* The key behind it, to show that parsing continues just fine */
-- 
2.50.1

