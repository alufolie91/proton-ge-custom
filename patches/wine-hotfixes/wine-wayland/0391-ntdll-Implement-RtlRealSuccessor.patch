From 3d3f21377af8cd84c4196af62268aa6db85c65d9 Mon Sep 17 00:00:00 2001
From: Zhiyi Zhang <zzhang@codeweavers.com>
Date: Fri, 24 Jan 2025 09:36:00 +0800
Subject: [PATCH 391/441] ntdll: Implement RtlRealSuccessor().

---
 dlls/ntdll/ntdll.spec               |  2 +-
 dlls/ntdll/rtl.c                    | 27 +++++++++++++++++++++++++++
 dlls/ntoskrnl.exe/ntoskrnl.exe.spec |  2 +-
 include/ddk/ntddk.h                 |  1 +
 4 files changed, 30 insertions(+), 2 deletions(-)

diff --git a/dlls/ntdll/ntdll.spec b/dlls/ntdll/ntdll.spec
index ffa0f4b937e..726e7e95572 100644
--- a/dlls/ntdll/ntdll.spec
+++ b/dlls/ntdll/ntdll.spec
@@ -971,7 +971,7 @@
 @ stub RtlReadMemoryStream
 @ stub RtlReadOutOfProcessMemoryStream
 @ stdcall RtlRealPredecessor(ptr)
-@ stub RtlRealSuccessor
+@ stdcall RtlRealSuccessor(ptr)
 @ stub RtlRegisterSecureMemoryCacheCallback
 @ stdcall RtlRegisterWait(ptr ptr ptr ptr long long)
 @ stdcall RtlReleaseActivationContext(ptr)
diff --git a/dlls/ntdll/rtl.c b/dlls/ntdll/rtl.c
index 00c211f7b5b..42a36814cbf 100644
--- a/dlls/ntdll/rtl.c
+++ b/dlls/ntdll/rtl.c
@@ -301,6 +301,33 @@ RTL_SPLAY_LINKS * WINAPI RtlRealPredecessor(RTL_SPLAY_LINKS *links)
     return NULL;
 }
 
+/******************************************************************************
+ *  RtlRealSuccessor           [NTDLL.@]
+ */
+RTL_SPLAY_LINKS * WINAPI RtlRealSuccessor(RTL_SPLAY_LINKS *links)
+{
+    PRTL_SPLAY_LINKS child;
+
+    TRACE("(%p)\n", links);
+
+    child = RtlRightChild(links);
+    if (child)
+    {
+        while (RtlLeftChild(child))
+            child = RtlLeftChild(child);
+        return child;
+    }
+
+    child = links;
+    while (RtlIsRightChild(child))
+        child = RtlParent(child);
+
+    if (RtlIsLeftChild(child))
+        return RtlParent(child);
+
+    return NULL;
+}
+
 /******************************************************************************
  *  RtlInitializeGenericTable           [NTDLL.@]
  */
diff --git a/dlls/ntoskrnl.exe/ntoskrnl.exe.spec b/dlls/ntoskrnl.exe/ntoskrnl.exe.spec
index 6022faf73ef..ac3b75156e8 100644
--- a/dlls/ntoskrnl.exe/ntoskrnl.exe.spec
+++ b/dlls/ntoskrnl.exe/ntoskrnl.exe.spec
@@ -1251,7 +1251,7 @@
 @ stdcall RtlRandom(ptr)
 @ stdcall RtlRandomEx(ptr)
 @ stdcall RtlRealPredecessor(ptr)
-@ stub RtlRealSuccessor
+@ stdcall RtlRealSuccessor(ptr)
 @ stub RtlRemoveUnicodePrefix
 @ stub RtlReserveChunk
 @ cdecl -arch=!i386 RtlRestoreContext(ptr ptr)
diff --git a/include/ddk/ntddk.h b/include/ddk/ntddk.h
index d8ae1dd73ce..aa56a1619a3 100644
--- a/include/ddk/ntddk.h
+++ b/include/ddk/ntddk.h
@@ -288,6 +288,7 @@ ULONG     WINAPI RtlNumberGenericTableElements(PRTL_GENERIC_TABLE);
 ULONG     WINAPI RtlNumberGenericTableElementsAvl(PRTL_AVL_TABLE);
 BOOLEAN   WINAPI RtlPrefixUnicodeString(const UNICODE_STRING*,const UNICODE_STRING*,BOOLEAN);
 PRTL_SPLAY_LINKS WINAPI RtlRealPredecessor(PRTL_SPLAY_LINKS);
+PRTL_SPLAY_LINKS WINAPI RtlRealSuccessor(PRTL_SPLAY_LINKS);
 PRTL_SPLAY_LINKS WINAPI RtlSubtreePredecessor(PRTL_SPLAY_LINKS);
 PRTL_SPLAY_LINKS WINAPI RtlSubtreeSuccessor(PRTL_SPLAY_LINKS);
 NTSTATUS  WINAPI RtlUpcaseUnicodeString(UNICODE_STRING*,const UNICODE_STRING*,BOOLEAN);
-- 
2.51.0

