From f3a7ef906684541318557421e6ccdda5d767fd61 Mon Sep 17 00:00:00 2001
From: Alexandre Julliard <julliard@winehq.org>
Date: Thu, 23 Jan 2025 12:46:54 +0100
Subject: [PATCH 338/378] include: Mark global asm functions as hidden.

---
 dlls/ntdll/unix/signal_i386.c   | 4 ++--
 dlls/ntdll/unix/signal_x86_64.c | 4 ++--
 include/wine/asm.h              | 5 ++++-
 3 files changed, 8 insertions(+), 5 deletions(-)

diff --git a/dlls/ntdll/unix/signal_i386.c b/dlls/ntdll/unix/signal_i386.c
index 48eb680a223..d1de0421081 100644
--- a/dlls/ntdll/unix/signal_i386.c
+++ b/dlls/ntdll/unix/signal_i386.c
@@ -2709,7 +2709,7 @@ __ASM_GLOBAL_FUNC( __wine_syscall_dispatcher,
                    __ASM_CFI(".cfi_adjust_cfa_offset 4\n\t")
                    "popl 0x04(%ecx)\n\t"           /* frame->eflags */
                    __ASM_CFI(".cfi_adjust_cfa_offset -4\n\t")
-                   ".globl " __ASM_NAME("__wine_syscall_dispatcher_prolog_end") "\n"
+                   __ASM_GLOBL(__ASM_NAME("__wine_syscall_dispatcher_prolog_end")) "\n"
                    __ASM_NAME("__wine_syscall_dispatcher_prolog_end") ":\n\t"
                    "movl %esp,0x0c(%ecx)\n\t"      /* frame->esp */
                    __ASM_CFI_CFA_IS_AT1(ecx, 0x0c)
@@ -2898,7 +2898,7 @@ __ASM_GLOBAL_FUNC( __wine_unix_call_dispatcher,
                    "popl 0x08(%ecx)\n\t"       /* frame->eip */
                    __ASM_CFI(".cfi_adjust_cfa_offset -4\n\t")
                    __ASM_CFI_REG_IS_AT1(eip, ecx, 0x08)
-                   ".globl " __ASM_NAME("__wine_unix_call_dispatcher_prolog_end") "\n"
+                   __ASM_GLOBL(__ASM_NAME("__wine_unix_call_dispatcher_prolog_end")) "\n"
                    __ASM_NAME("__wine_unix_call_dispatcher_prolog_end") ":\n\t"
                    "leal 0x10(%esp),%edx\n\t"
                    "movl %edx,0x0c(%ecx)\n\t"  /* frame->esp */
diff --git a/dlls/ntdll/unix/signal_x86_64.c b/dlls/ntdll/unix/signal_x86_64.c
index 033c9ed90b8..11e8b4bd592 100644
--- a/dlls/ntdll/unix/signal_x86_64.c
+++ b/dlls/ntdll/unix/signal_x86_64.c
@@ -3611,10 +3611,10 @@ __ASM_GLOBAL_FUNC( __wine_unix_call_dispatcher,
                    "ret" )
 
 asm( ".data\n\t"
-     ".globl " __ASM_NAME("__wine_syscall_dispatcher_prolog_end_ptr") "\n"
+     __ASM_GLOBL(__ASM_NAME("__wine_syscall_dispatcher_prolog_end_ptr")) "\n"
      __ASM_NAME("__wine_syscall_dispatcher_prolog_end_ptr") ":\n\t"
      ".quad " __ASM_LOCAL_LABEL("__wine_syscall_dispatcher_prolog_end") "\n\t"
-     ".globl " __ASM_NAME("__wine_unix_call_dispatcher_prolog_end_ptr") "\n"
+     __ASM_GLOBL(__ASM_NAME("__wine_unix_call_dispatcher_prolog_end_ptr")) "\n"
      __ASM_NAME("__wine_unix_call_dispatcher_prolog_end_ptr") ":\n\t"
      ".quad " __ASM_LOCAL_LABEL("__wine_unix_call_dispatcher_prolog_end") "\n\t"
      ".text\n\t" );
diff --git a/include/wine/asm.h b/include/wine/asm.h
index 6cf75225fd7..836ba39923a 100644
--- a/include/wine/asm.h
+++ b/include/wine/asm.h
@@ -64,10 +64,13 @@
 #endif
 
 #ifdef __WINE_PE_BUILD
+# define __ASM_GLOBL(name) ".globl " name
 # define __ASM_FUNC_SIZE(name) ""
 #elif defined(__APPLE__)
+# define __ASM_GLOBL(name) ".globl " name "\n\t.private_extern " name
 # define __ASM_FUNC_SIZE(name) ""
 #else
+# define __ASM_GLOBL(name) ".globl " name "\n\t.hidden " name
 # define __ASM_FUNC_SIZE(name) ".size " name ",.-" name
 #endif
 
@@ -91,8 +94,8 @@
     __ASM_BLOCK_BEGIN(__LINE__) \
     asm( __ASM_FUNC_SECTION(name) "\n\t" \
          __ASM_FUNC_ALIGN "\n\t" \
-         ".globl " name "\n\t" \
          __ASM_FUNC_TYPE(name) "\n" \
+         __ASM_GLOBL(name) "\n\t" \
          name ":\n\t" \
          __ASM_SEH(".seh_proc " name "\n\t") \
          __ASM_CFI(".cfi_startproc\n\t") \
-- 
2.51.0

