From d8a6403e13785e2b7a3a1251df858fb6d9f261a9 Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Wed, 10 Dec 2025 23:47:05 -0600
Subject: [PATCH 412/473] amdxc: Some minor code cleanups.

---
 dlls/amdxc64/amdxc_interfaces.idl | 16 ++++----
 dlls/amdxc64/main.c               | 67 +++++++++++++++++++------------
 2 files changed, 50 insertions(+), 33 deletions(-)

diff --git a/dlls/amdxc64/amdxc_interfaces.idl b/dlls/amdxc64/amdxc_interfaces.idl
index 8a6c8e0011e..a3bca8400ba 100644
--- a/dlls/amdxc64/amdxc_interfaces.idl
+++ b/dlls/amdxc64/amdxc_interfaces.idl
@@ -173,14 +173,14 @@ cpp_quote("#define AMD_EXT_WMMA_TYPE_FP8 11")
 
 typedef struct
 {
-    SIZE_T   mSize;
-    SIZE_T   nSize;
-    SIZE_T   kSize;
-    ULONG    aType;
-    ULONG    bType;
-    ULONG    cType;
-    ULONG    resultType;
-    BOOL     saturatingAccumulation;
+    SIZE_T   mSize; /* 0 */
+    SIZE_T   nSize; /* 8 */
+    SIZE_T   kSize; /* 10 */
+    ULONG    aType; /* 14 */
+    ULONG    bType; /* 18 */
+    ULONG    cType; /* 1c */
+    ULONG    resultType; /* 20 */
+    ULONG    saturatingAccumulation; /* 24 */
 } AmdExtWaveMatrixProperties;
 
 typedef struct
diff --git a/dlls/amdxc64/main.c b/dlls/amdxc64/main.c
index f2623c73fda..6cadb49102b 100644
--- a/dlls/amdxc64/main.c
+++ b/dlls/amdxc64/main.c
@@ -148,22 +148,39 @@ typedef HRESULT (__stdcall *updateffxapi_pfn)(void*, unsigned int);
 /* SDK 2.1.0 requires this */
 typedef HRESULT (__stdcall *updateffxapi_pfn_ex)(void*, unsigned int, void*);
 
-struct ffxProvider
+typedef ULONG (*pfnCanProvide)(ULONG64 typeId);
+typedef ULONG (*pfnCreateContext)(void* context, void* desc, const void* allocator);
+typedef ULONG (*pfnDestroyContext)(void* context, const void* allocator);
+typedef ULONG (*pfnConfigure)(void* context, const void* desc);
+typedef ULONG (*pfnQuery)(void* context, void* desc);
+typedef ULONG (*pfnDispatch)(void* context, const void* desc);
+
+struct ffxProviderInterface
+{
+    ULONG64 versionId;
+    const char* versionName;
+    pfnCanProvide canProvide;
+    pfnCreateContext createContext;
+    pfnDestroyContext destroyContext;
+    pfnConfigure configure;
+    pfnQuery query;
+    pfnDispatch dispatch;
+};
+
+struct ffxExternalProvider
 {
-    void *vtable;
-    volatile ULONG64 ref;
-    ULONG64 id;
-    ULONG64 effect_id;
-    const char* version;
+    ULONG structVersion;
+    ULONG64 descType;
+    struct ffxProviderInterface iface;
 };
 
-static void dump_provider(struct ffxProvider *provider)
+static void dump_provider(struct ffxExternalProvider *provider)
 {
     if (!provider) return;
 
-    TRACE("returned provider: %p %I64x %I64x %I64x %s\n",
-          provider->vtable, provider->ref, provider->id,
-          provider->effect_id, debugstr_a(provider->version));
+    TRACE("returned provider: %lx %I64x %s\n",
+          provider->structVersion, provider->descType,
+          debugstr_a(provider->iface.versionName));
 }
 
 struct unk_data {
@@ -174,7 +191,7 @@ struct unk_data {
 HRESULT STDMETHODCALLTYPE AMDFSR4FFX_UpdateFfxApiProvider(IAmdExtFfxApi *iface, void *_data, unsigned int size)
 {
     struct AMDFSR4FFX *this = impl_from_IAmdExtFfxApi(iface);
-    struct ffxProvider *data = _data;
+    struct ffxExternalProvider *data = _data;
     /* required to expose MLFG support */
     struct unk_data unk_data[1] =
     {
@@ -187,9 +204,9 @@ HRESULT STDMETHODCALLTYPE AMDFSR4FFX_UpdateFfxApiProvider(IAmdExtFfxApi *iface,
 
     TRACE("%p %p %u\n", iface, data, size);
 
-    env = getenv("FSR4_UPGRADE");
+    if (!data) return E_INVALIDARG;
 
-    if (env && !strcmp(env, "1"))
+    if ((env = getenv("FSR4_UPGRADE")) && !strcmp(env, "1"))
     {
         amdffx = LoadLibraryA("amdxcffx64");
         if (!amdffx)
@@ -442,20 +459,20 @@ HRESULT STDMETHODCALLTYPE AmdExtD3DDevice8_GetWaveMatrixProperties(IAmdExtD3DDev
 
     if (!pCount) return E_INVALIDARG;
 
-    if (*pCount >= 1)
+    if (!this->fsr4_supported)
     {
-        if (this->fsr4_supported)
-        {
-            *pCount = 1;
-            memcpy(pProperties, prop, sizeof(prop));
-            return S_OK;
-        } else {
-            *pCount = 0;
-            return S_OK;
-        }
-    } /* FIXME: Handle pCount == 0 */
+        *pCount = 0;
+        return S_OK;
+    }
 
-    return S_OK;
+    if (*pCount >= sizeof(prop)/sizeof(prop[0]))
+    {
+        *pCount = sizeof(prop)/sizeof(prop[0]);
+        memcpy(pProperties, prop, sizeof(prop));
+        return S_OK;
+    }
+
+    return E_NOT_SUFFICIENT_BUFFER;
 }
 
 static const struct IAmdExtD3DDevice8Vtbl AmdExtD3DDevice8_vtable = {
-- 
2.52.0

