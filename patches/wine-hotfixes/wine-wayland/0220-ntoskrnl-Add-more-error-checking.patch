From c688201528977f3f793e58e7544c1f1c222ed39b Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Thu, 24 Jul 2025 19:53:46 -0400
Subject: [PATCH 220/327] ntoskrnl: Add more error checking

---
 dlls/ntoskrnl.exe/ntoskrnl.c | 33 +++++++++++++++++++--------------
 1 file changed, 19 insertions(+), 14 deletions(-)

diff --git a/dlls/ntoskrnl.exe/ntoskrnl.c b/dlls/ntoskrnl.exe/ntoskrnl.c
index 1c6e236c17e..7bc49b304e1 100644
--- a/dlls/ntoskrnl.exe/ntoskrnl.c
+++ b/dlls/ntoskrnl.exe/ntoskrnl.c
@@ -2475,24 +2475,29 @@ static void *create_process_object( HANDLE handle )
 
     /* get full image name */
     NtQueryInformationProcess( handle, ProcessImageFileNameWin32, fullImageNameW, 0, &len );
-    fullImageNameW = malloc(len + sizeof(WCHAR));
-    if (!fullImageNameW) return NULL;
-    fullImageNameW->MaximumLength = len + sizeof(WCHAR);
-    NtQueryInformationProcess( handle, ProcessImageFileNameWin32, fullImageNameW, len, &len );
-    RtlUnicodeStringToAnsiString(&fullImageNameA, fullImageNameW, TRUE);
-    if (!fullImageNameA.Buffer) return NULL;
-    /* generate short name */
-    for (p = fullImageNameA.Buffer + fullImageNameA.Length - 1; p >= fullImageNameA.Buffer; p--)
+    fullImageNameW = calloc(len + 1, sizeof(WCHAR));
+    if (fullImageNameW)
     {
-        if (*p == '\\')
+        fullImageNameW->MaximumLength = len + sizeof(WCHAR);
+        NtQueryInformationProcess( handle, ProcessImageFileNameWin32, fullImageNameW, len, &len );
+        if (fullImageNameW->Buffer)
         {
-            ++p;
-            break;
+            RtlUnicodeStringToAnsiString(&fullImageNameA, fullImageNameW, TRUE);
+            if (fullImageNameA.Buffer)
+            {
+                /* generate short name */
+                for (p = fullImageNameA.Buffer + fullImageNameA.Length - 1; p > fullImageNameA.Buffer; p--)
+                {
+                    if (*(p-1) == '\\') break;
+                }
+                memcpy(process->imageName, p,
+                       min(fullImageNameA.Buffer + fullImageNameA.Length - p,
+                           sizeof(process->imageName)));
+                RtlFreeAnsiString(&fullImageNameA);
+            }
         }
+        free(fullImageNameW);
     }
-    memcpy(process->imageName, p, min(fullImageNameA.Buffer + fullImageNameA.Length - p, sizeof(process->imageName)));
-    RtlFreeAnsiString(&fullImageNameA);
-    free(fullImageNameW);
 
     IsWow64Process( handle, &process->wow64 );
 
-- 
2.51.0

