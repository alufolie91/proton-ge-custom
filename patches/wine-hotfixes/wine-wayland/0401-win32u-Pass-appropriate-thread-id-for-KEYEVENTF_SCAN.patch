From 70af7f77481bf1dcdc701370f83b8e6406ea369b Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Thu, 27 Nov 2025 03:57:18 -0500
Subject: [PATCH 401/406] win32u: Pass appropriate thread id for
 KEYEVENTF_SCANCODE.

---
 dlls/win32u/message.c                   |  4 +---
 dlls/winewayland.drv/wayland_keyboard.c | 25 +------------------------
 2 files changed, 2 insertions(+), 27 deletions(-)

diff --git a/dlls/win32u/message.c b/dlls/win32u/message.c
index eea29ed05a9..273054de679 100644
--- a/dlls/win32u/message.c
+++ b/dlls/win32u/message.c
@@ -3787,9 +3787,7 @@ NTSTATUS send_hardware_message( HWND hwnd, UINT flags, const INPUT *input, LPARA
             if (input->ki.dwFlags & KEYEVENTF_SCANCODE)
             {
                 UINT scan = input->ki.wScan;
-                /* TODO: Use the keyboard layout of the target hwnd, once
-                 * NtUserGetKeyboardLayout supports non-current threads. */
-                HKL layout = NtUserGetKeyboardLayout( 0 );
+                HKL layout = NtUserGetKeyboardLayout(NtUserGetWindowThread( hwnd, NULL ));
                 if (flags & SEND_HWMSG_INJECTED)
                 {
                     scan = scan & 0xff;
diff --git a/dlls/winewayland.drv/wayland_keyboard.c b/dlls/winewayland.drv/wayland_keyboard.c
index 93a30a6b325..6d8bd4f55c1 100644
--- a/dlls/winewayland.drv/wayland_keyboard.c
+++ b/dlls/winewayland.drv/wayland_keyboard.c
@@ -1031,7 +1031,6 @@ static void keyboard_handle_key(void *data, struct wl_keyboard *wl_keyboard,
 {
     UINT scan = key2scan(key);
     INPUT input = {0};
-    const KBDTABLES *tables;
     HWND hwnd;
 
     InterlockedExchange(&process_wayland.input_serial, serial);
@@ -1057,29 +1056,7 @@ static void keyboard_handle_key(void *data, struct wl_keyboard *wl_keyboard,
     input.ki.wScan = (scan & 0x300) ? scan + 0xdf00 : scan;
     if (scan & ~0xff) input.ki.dwFlags |= KEYEVENTF_EXTENDEDKEY;
 
-    if ((tables = WAYLAND_KbdLayerDescriptor(keyboard_hkl)))
-    {
-        if (scan < 0x100)
-            input.ki.wVk = tables->pusVSCtoVK[scan];
-        else
-        {
-            const VSC_VK *entry;
-
-            for (entry = tables->pVSCtoVK_E0; entry && entry->Vsc && !input.ki.wVk; entry++)
-            {
-                if (entry->Vsc + 0x100 == scan)
-                    input.ki.wVk = entry->Vk;
-            }
-            for (entry = tables->pVSCtoVK_E1; entry && entry->Vsc && !input.ki.wVk; entry++)
-            {
-                if (entry->Vsc + 0x200 == scan)
-                    input.ki.wVk = entry->Vk;
-            }
-        }
-
-        WAYLAND_ReleaseKbdTables(tables);
-    } else input.ki.dwFlags |= KEYEVENTF_SCANCODE;
-
+    input.ki.dwFlags |= KEYEVENTF_SCANCODE;
     if (state == WL_KEYBOARD_KEY_STATE_RELEASED) input.ki.dwFlags |= KEYEVENTF_KEYUP;
 
     NtUserSendHardwareInput(hwnd, 0, &input, 0);
-- 
2.51.1

