From bbdaf04ef4da7e9f8524f4bd788c77d3de1493f8 Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Wed, 10 Sep 2025 12:29:19 -0500
Subject: [PATCH 333/336] winewayland: redraw surface contents after fractional
 scale event.

---
 dlls/winewayland.drv/wayland_surface.c | 18 +++++++++++++++++-
 1 file changed, 17 insertions(+), 1 deletion(-)

diff --git a/dlls/winewayland.drv/wayland_surface.c b/dlls/winewayland.drv/wayland_surface.c
index 1adc6e8dd01..9d931cf5565 100644
--- a/dlls/winewayland.drv/wayland_surface.c
+++ b/dlls/winewayland.drv/wayland_surface.c
@@ -144,7 +144,7 @@ static void wp_fractional_scale_handle_scale(void *user_data,
     struct wayland_win_data *data;
     struct wayland_surface *surface;
     HWND hwnd = user_data;
-    assert(hwnd);
+    BOOL set_scale = FALSE;
 
     if ((data = wayland_win_data_get(hwnd)))
     {
@@ -153,12 +153,28 @@ static void wp_fractional_scale_handle_scale(void *user_data,
             surface->window.fractional_scale = scale / 120.0;
             surface->window.scale =
                 surface->window.fractional_scale * NtUserGetSystemDpiForProcess(0) / 96.0;
+            set_scale = TRUE;
 
             TRACE("Got scale %lf\n", surface->window.fractional_scale);
         }
 
         wayland_win_data_release(data);
     }
+
+    /* redraw contents if possible
+     * TODO: work around potential race conditions
+     */
+    if (set_scale)
+    {
+        HRGN region;
+        struct wayland_shm_buffer *buffer;
+        buffer = get_window_surface_contents(hwnd);
+        if (buffer && (region = NtGdiCreateRectRgn(0, 0, INT32_MAX, INT32_MAX)))
+        {
+            set_window_surface_contents(hwnd, buffer, region);
+            NtGdiDeleteObjectApp(region);
+        }
+    }
 }
 
 static const struct wp_fractional_scale_v1_listener wp_fractional_scale_listener =
-- 
2.51.0

