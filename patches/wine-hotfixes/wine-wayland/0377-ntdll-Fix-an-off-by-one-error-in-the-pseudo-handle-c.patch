From df7013bf01a086b84ddeea7fe8a13b4ca6aa1806 Mon Sep 17 00:00:00 2001
From: Marc-Aurel Zent <mzent@codeweavers.com>
Date: Thu, 30 Oct 2025 22:02:27 +0100
Subject: [PATCH 377/410] ntdll: Fix an off-by-one error in the pseudo-handle
 check for inproc syncs.

Also add an is_pseudo_handle() helper.
---
 dlls/ntdll/unix/sync.c | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/dlls/ntdll/unix/sync.c b/dlls/ntdll/unix/sync.c
index 9ee0a14e062..e3363b54645 100644
--- a/dlls/ntdll/unix/sync.c
+++ b/dlls/ntdll/unix/sync.c
@@ -416,6 +416,12 @@ static inline unsigned int inproc_sync_handle_to_index( HANDLE handle, unsigned
     return idx % INPROC_SYNC_CACHE_BLOCK_SIZE;
 }
 
+
+static BOOL is_pseudo_handle( HANDLE handle )
+{
+    return ((ULONG)(ULONG_PTR)handle >= 0xfffffffa);
+}
+
 static struct inproc_sync_cache_entry *cache_inproc_sync_obj( HANDLE handle, int fd,
                                                               enum inproc_sync_type type, unsigned int access )
 {
@@ -424,8 +430,7 @@ static struct inproc_sync_cache_entry *cache_inproc_sync_obj( HANDLE handle, int
     int refcount;
 
     /* don't cache pseudo-handles; waiting on them is pointless anyway */
-    if ((ULONG)(ULONG_PTR)handle > 0xfffffffa)
-        return FALSE;
+    if (is_pseudo_handle( handle )) return FALSE;
 
     if (entry >= INPROC_SYNC_CACHE_ENTRIES)
     {
-- 
2.51.1

