From 180836e3f96d9c94f752b2d12f1d9a90ad3fb22d Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Wed, 28 May 2025 22:20:47 -0400
Subject: [PATCH 079/327] HACK: winewayland: Send relative event with absolute
 event.

---
 dlls/winewayland.drv/wayland_pointer.c | 22 ++++++++++++++++++++++
 dlls/winewayland.drv/waylanddrv.h      |  3 +++
 2 files changed, 25 insertions(+)

diff --git a/dlls/winewayland.drv/wayland_pointer.c b/dlls/winewayland.drv/wayland_pointer.c
index 3caa9f4243d..fde360a6e64 100644
--- a/dlls/winewayland.drv/wayland_pointer.c
+++ b/dlls/winewayland.drv/wayland_pointer.c
@@ -54,6 +54,7 @@ static void pointer_handle_motion_internal(wl_fixed_t sx, wl_fixed_t sy)
     POINT screen;
     struct wayland_surface *surface;
     struct wayland_win_data *data;
+    struct wayland_pointer *pointer = &process_wayland.pointer;
 
     if (!(hwnd = wayland_pointer_get_focused_hwnd())) return;
     if (!(data = wayland_win_data_get(hwnd))) return;
@@ -89,6 +90,25 @@ static void pointer_handle_motion_internal(wl_fixed_t sx, wl_fixed_t sy)
           hwnd, wl_fixed_to_double(sx), wl_fixed_to_double(sy),
           (int)screen.x, (int)screen.y);
 
+    if (InterlockedCompareExchange(&pointer->confinement_updated, FALSE, TRUE))
+    {
+        TRACE("Ignoring, confinement was updated recently!\n");
+        pointer->last_x = screen.x;
+        pointer->last_y = screen.y;
+        return;
+    }
+
+    NtUserSendHardwareInput(hwnd, 0, &input, 0);
+
+    input.mi.dx -= pointer->last_x;
+    input.mi.dy -= pointer->last_y;
+    input.mi.dwFlags = MOUSEEVENTF_MOVE;
+
+    TRACE("relative=%d,%d\n", input.mi.dx, input.mi.dy);
+
+    pointer->last_x = screen.x;
+    pointer->last_y = screen.y;
+
     NtUserSendHardwareInput(hwnd, 0, &input, 0);
 }
 
@@ -875,6 +895,8 @@ static void wayland_pointer_update_constraint(struct wl_surface *wl_surface,
         pointer->zwp_relative_pointer_v1 = NULL;
         TRACE("Disabling relative motion\n");
     }
+
+    InterlockedExchange(&pointer->confinement_updated, TRUE);
 }
 
 void wayland_pointer_clear_constraint(void)
diff --git a/dlls/winewayland.drv/waylanddrv.h b/dlls/winewayland.drv/waylanddrv.h
index 58a05eeee52..8bbd14b6784 100644
--- a/dlls/winewayland.drv/waylanddrv.h
+++ b/dlls/winewayland.drv/waylanddrv.h
@@ -111,8 +111,11 @@ struct wayland_pointer
     HWND focused_hwnd;
     HWND constraint_hwnd;
     BOOL pending_warp;
+    BOOL confinement_updated;
     uint32_t enter_serial;
     uint32_t button_serial;
+    LONG last_x;
+    LONG last_y;
     struct wayland_cursor cursor;
     double accum_x;
     double accum_y;
-- 
2.51.0

