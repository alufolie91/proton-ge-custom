From 5da6fa297687fc1c6123fcfa9eb351010eaa4dc5 Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Fri, 9 Jan 2026 20:03:43 -0500
Subject: [PATCH 477/479] HACK: winegstreamer: Add semi-stub for
 GetAttributeIndices/GetAttributeByIndexEx.

fixes gta iv independence radio scan
---
 dlls/winegstreamer/wm_reader.c | 64 ++++++++++++++++++++++++++++++++--
 1 file changed, 62 insertions(+), 2 deletions(-)

diff --git a/dlls/winegstreamer/wm_reader.c b/dlls/winegstreamer/wm_reader.c
index 7e2316c940b..c1b5c0475cb 100644
--- a/dlls/winegstreamer/wm_reader.c
+++ b/dlls/winegstreamer/wm_reader.c
@@ -1201,11 +1201,34 @@ static HRESULT WINAPI header_info_GetAttributeCountEx(IWMHeaderInfo3 *iface, WOR
     return E_NOTIMPL;
 }
 
+/* made up index, just be consistent. needs a test */
+#define WMV_ATTRIBUTE_DURATION 1
+
 static HRESULT WINAPI header_info_GetAttributeIndices(IWMHeaderInfo3 *iface, WORD stream_number,
         const WCHAR *name, WORD *lang_index, WORD *indices, WORD *count)
 {
-    FIXME("iface %p, stream_number %u, name %s, lang_index %p, indices %p, count %p, stub!\n",
+    FIXME("iface %p, stream_number %u, name %s, lang_index %p, indices %p, count %p, semi-stub!\n",
             iface, stream_number, debugstr_w(name), lang_index, indices, count);
+
+    if (!count) return E_INVALIDARG;
+
+    if (lang_index) FIXME("lang_index not supported!\n");
+
+    if (stream_number)
+    {
+        WARN("Requesting %s for stream %u, returning ASF_E_NOTFOUND.\n", debugstr_w(name), stream_number);
+        return ASF_E_NOTFOUND;
+    }
+
+    if (!wcscmp(name, L"Duration"))
+    {
+        *count = 1;
+        if (indices) *indices = WMV_ATTRIBUTE_DURATION;
+        return S_OK;
+    }
+
+    FIXME("Unsupported attribute %s\n", debugstr_w(name));
+
     return E_NOTIMPL;
 }
 
@@ -1213,9 +1236,46 @@ static HRESULT WINAPI header_info_GetAttributeByIndexEx(IWMHeaderInfo3 *iface,
         WORD stream_number, WORD index, WCHAR *name, WORD *name_len,
         WMT_ATTR_DATATYPE *type, WORD *lang_index, BYTE *value, DWORD *size)
 {
+    WORD temp_size;
+    HRESULT hr;
+
     FIXME("iface %p, stream_number %u, index %u, name %p, name_len %p,"
-            " type %p, lang_index %p, value %p, size %p, stub!\n",
+            " type %p, lang_index %p, value %p, size %p, semi-stub!\n",
             iface, stream_number, index, name, name_len, type, lang_index, value, size);
+
+    if (!size || !name_len) return E_INVALIDARG;
+
+    if (lang_index) FIXME("lang_index not supported!\n");
+
+    if (stream_number)
+    {
+        WARN("Requesting index %u for stream %u, returning ASF_E_NOTFOUND.\n", index, stream_number);
+        return ASF_E_NOTFOUND;
+    }
+
+    temp_size = *size;
+
+    switch (index)
+    {
+        case WMV_ATTRIBUTE_DURATION:
+        {
+            const WCHAR *durationW = L"Duration";
+            const int durationLen = wcslen(durationW)+1;
+
+            if (name && *name_len >= durationLen) wcscpy(name, durationW);
+            else if (name) return ASF_E_BUFFERTOOSMALL;
+
+            *name_len = durationLen;
+
+            hr = header_info_GetAttributeByName(iface, &stream_number, durationW, type, value, &temp_size);
+            *size = temp_size;
+            return hr;
+        }
+        default:
+            FIXME("Unsupported attribute index %u\n", index);
+            return E_INVALIDARG;
+    }
+
     return E_NOTIMPL;
 }
 
-- 
2.52.0

