From 99927972f77267c4e3f3ac565bc37530ef7b7c40 Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Sat, 20 Dec 2025 13:19:03 -0500
Subject: [PATCH 417/479] winewayland: slightly refactor wayland output
 switching.

---
 dlls/winewayland.drv/wayland_surface.c | 28 ++++++++++++--------------
 1 file changed, 13 insertions(+), 15 deletions(-)

diff --git a/dlls/winewayland.drv/wayland_surface.c b/dlls/winewayland.drv/wayland_surface.c
index 82bb08e2443..874e424a91e 100644
--- a/dlls/winewayland.drv/wayland_surface.c
+++ b/dlls/winewayland.drv/wayland_surface.c
@@ -687,24 +687,22 @@ static void wayland_surface_reconfigure_geometry(struct wayland_surface *surface
                                         rect.left, rect.top,
                                         rect.right - rect.left,
                                         rect.bottom - rect.top);
-        if (wayland_surface_is_toplevel(surface))
+        /* HACK: reset fullscreen state to ensure surface is on correct output */
+        if (wayland_surface_is_toplevel(surface) &&
+            surface->current.state & WAYLAND_SURFACE_CONFIG_STATE_FULLSCREEN)
         {
-            /* HACK: reset fullscreen state to ensure surface is on correct output */
-            if (surface->current.state & WAYLAND_SURFACE_CONFIG_STATE_FULLSCREEN)
+            struct wl_output *output;
+            pthread_mutex_lock(&process_wayland.output_mutex);
+            output = wayland_get_best_output_for_rect(&surface->window.rect);
+            if (output != surface->requested_output)
             {
-                struct wl_output *output;
-                pthread_mutex_lock(&process_wayland.output_mutex);
-                output = wayland_get_best_output_for_rect(&surface->window.rect);
-                if (output != surface->requested_output)
-                {
-                    TRACE("Resetting fullscreen state: output %p, old output %p\n",
-                        output, surface->requested_output);
-                    xdg_toplevel_set_fullscreen(surface->xdg_toplevel, output);
-                    wl_display_flush(process_wayland.wl_display);
-                    surface->requested_output = output;
-                }
-                pthread_mutex_unlock(&process_wayland.output_mutex);
+                TRACE("Updating fullscreen output: output %p, old output %p\n",
+                    output, surface->requested_output);
+                xdg_toplevel_set_fullscreen(surface->xdg_toplevel, output);
+                wl_display_flush(process_wayland.wl_display);
+                surface->requested_output = output;
             }
+            pthread_mutex_unlock(&process_wayland.output_mutex);
         }
     }
 }
-- 
2.52.0

