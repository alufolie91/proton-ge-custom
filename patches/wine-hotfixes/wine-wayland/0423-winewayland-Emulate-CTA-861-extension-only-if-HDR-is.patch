From 6411b7137a78ad8227d82b67f695f2b1bdfb0550 Mon Sep 17 00:00:00 2001
From: Etaash Mathamsetty
 <45927311+Etaash-mathamsetty@users.noreply.github.com>
Date: Sun, 21 Dec 2025 23:42:26 -0500
Subject: [PATCH 423/479] winewayland: Emulate CTA-861 extension only if HDR is
 supported.

---
 dlls/winewayland.drv/display.c | 53 ++++++++++++++++++++--------------
 1 file changed, 32 insertions(+), 21 deletions(-)

diff --git a/dlls/winewayland.drv/display.c b/dlls/winewayland.drv/display.c
index 08a7aa70738..e25adc5b92b 100644
--- a/dlls/winewayland.drv/display.c
+++ b/dlls/winewayland.drv/display.c
@@ -270,7 +270,7 @@ static uint8_t encode_max_luminance(float nits)
 /* emulate some edid data */
 static UINT get_edid(const struct output_info *output_info, unsigned char **data_out)
 {
-    const unsigned int edid_size = 256;
+    unsigned int edid_size = 128, extensions = 0;
     unsigned char *data, *p;
     unsigned int i, mwidth, mheight;
     unsigned char c;
@@ -289,6 +289,12 @@ static UINT get_edid(const struct output_info *output_info, unsigned char **data
         mheight = mode->height / 60;
     }
 
+    if (output_info->output->supports_hdr)
+    {
+        edid_size += 128;
+        extensions++;
+    }
+
     /* another 128 bytes needed for CTA-861 extension */
     *data_out = calloc( 1, edid_size );
     data = *data_out;
@@ -376,37 +382,42 @@ static UINT get_edid(const struct output_info *output_info, unsigned char **data
     p[3] = 0x10;
 
     c = 0;
-    data[126] = 1; /* one extension */
+    data[126] = extensions; /* one extension */
     for (i = 0; i < 127; ++i)
         c += data[i];
     data[127] = 256 - c;
 
-    p = data + 128;
+    p = data;
+
+    if (output_info->output->supports_hdr)
+    {
+        p += 128;
 
-    p[0] = 2;
-    p[1] = 3;
-    p[2] = 0xa; /* FIXME: is this correct?  */
+        p[0] = 2;
+        p[1] = 3;
+        p[2] = 0xa; /* FIXME: is this correct?  */
 
-    p += 4;
+        p += 4;
 
-    p[0] = (0x7 << 5) | 0x5; /* HDR static metadata size */
-    p[1] = 6;
+        p[0] = (0x7 << 5) | 0x5; /* HDR static metadata size */
+        p[1] = 6;
 
-    /* HDR static metadata block */
+        /* HDR static metadata block */
 
-    p[2] = 0x7; /* ST2084 | SDR | HDR */
-    p[3] = 1;
-    p[4] = encode_max_luminance(output_info->output->max_cll);
-    p[5] = encode_max_luminance(output_info->output->max_fall);
-    p[6] = 0; /* assume undefined */
+        p[2] = 0x7; /* ST2084 | SDR | HDR */
+        p[3] = 1;
+        p[4] = encode_max_luminance(output_info->output->max_cll);
+        p[5] = encode_max_luminance(output_info->output->max_fall);
+        p[6] = 0; /* assume undefined */
 
-    /* reset p to beginning of the CTA block */
-    p = data + 128;
-    c = 0;
+        /* reset p to beginning of the CTA block */
+        p = data + 128;
+        c = 0;
 
-    for (i = 0; i < 127; ++i)
-        c += p[i];
-    p[127] = 256 - c;
+        for (i = 0; i < 127; ++i)
+            c += p[i];
+        p[127] = 256 - c;
+    }
 
     return edid_size;
 }
-- 
2.52.0

